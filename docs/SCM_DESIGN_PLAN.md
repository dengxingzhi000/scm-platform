# ä¾›åº”é“¾ç®¡ç†ç³»ç»Ÿï¼ˆSCMï¼‰æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ
**å¯¹æ ‡äº’è”ç½‘å¤§å‚çš„ä¼ä¸šçº§ä¾›åº”é“¾å¹³å°**

## ğŸ“š å¯¹æ ‡å¤§å‚å‚è€ƒ

- **é˜¿é‡Œå·´å·´**: èœé¸Ÿä¾›åº”é“¾ã€1688é‡‡è´­å¹³å°
- **äº¬ä¸œ**: äº¬ä¸œç‰©æµWMSã€JD Supply Chain
- **ç¾å›¢**: ç¾å›¢é…é€ã€å¿«é©´è¿›è´§
- **æ‹¼å¤šå¤š**: å¤šå¤šä¹°èœä¾›åº”é“¾
- **å­—èŠ‚è·³åŠ¨**: æŠ–éŸ³ç”µå•†ä¾›åº”é“¾

---

## ä¸€ã€å½“å‰ç³»ç»Ÿèƒ½åŠ›è¯„ä¼°

### âœ… å·²å…·å¤‡çš„æ ¸å¿ƒèƒ½åŠ›

#### 1. åŸºç¡€è®¾æ–½å±‚
- **å¾®æœåŠ¡æ¶æ„**: Spring Cloud 2025 + Nacos + Dubbo
- **APIç½‘å…³**: Spring Cloud Gatewayï¼ˆé™æµã€ç­¾åã€IPæ§åˆ¶ï¼‰
- **æœåŠ¡æ²»ç†**: Sentinelç†”æ–­é™çº§ã€Resilience4jå®¹é”™
- **é…ç½®ä¸­å¿ƒ**: NacosåŠ¨æ€é…ç½®

#### 2. æ•°æ®è®¿é—®å±‚
- **è¯»å†™åˆ†ç¦»**: 5ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ + è‡ªåŠ¨æ•…éšœè½¬ç§»
- **åˆ†åº“åˆ†è¡¨**: ShardingSphere ready
- **ä¸¤çº§ç¼“å­˜**: Caffeine(L1) + Redis(L2)
- **ORMæ¡†æ¶**: MyBatis-Plus 3.5.15

#### 3. å®‰å…¨ä½“ç³»
- **è®¤è¯æˆæƒ**: JWT + OAuth2 + WebAuthn
- **æƒé™ç®¡ç†**: RBAC + æ•°æ®æƒé™ï¼ˆ@DataScopeï¼‰
- **APIå®‰å…¨**: HMAC-SHA256ç­¾å + SQLæ³¨å…¥é˜²æŠ¤
- **å®¡è®¡æ—¥å¿—**: æ•æ„Ÿæ“ä½œè®°å½•

#### 4. æ¶ˆæ¯é©±åŠ¨
- **æ¶ˆæ¯é˜Ÿåˆ—**: Kafka + RabbitMQåŒå¼•æ“
- **å¯é æŠ•é€’**: å¹‚ç­‰æ€§ä¿è¯ + DLQé‡è¯•
- **äº‹ä»¶æº¯æº**: CloudEventsæ ‡å‡†

#### 5. å¯è§‚æµ‹æ€§
- **é“¾è·¯è¿½è¸ª**: SkyWalkingé›†æˆ
- **æŒ‡æ ‡ç›‘æ§**: Prometheus + Micrometer
- **å¥åº·æ£€æŸ¥**: Actuatorç«¯ç‚¹

### âŒ ä¾›åº”é“¾ç³»ç»Ÿéœ€è¦è¡¥å……çš„èƒ½åŠ›

#### 1. åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå…³é”®ç¼ºå¤± âš ï¸ï¼‰
- âŒ **Seata/TCC/SAGA**: è®¢å•-åº“å­˜-æ”¯ä»˜ä¸€è‡´æ€§
- âŒ **æœ¬åœ°æ¶ˆæ¯è¡¨**: æœ€ç»ˆä¸€è‡´æ€§ä¿è¯
- âŒ **å¹‚ç­‰æ¡†æ¶å¢å¼º**: é˜²æ­¢é‡å¤æ‰£å‡åº“å­˜

#### 2. é«˜å¹¶å‘å¤„ç†
- âš ï¸ **é™æµé™çº§**: Sentinelå·²æœ‰ï¼Œéœ€é’ˆå¯¹ç§’æ€åœºæ™¯åŠ å¼º
- âŒ **æµé‡å‰Šå³°**: æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥åŒ–ï¼ˆéœ€ä¸“é—¨è®¾è®¡ï¼‰
- âŒ **çƒ­ç‚¹æ•°æ®**: Redisé›†ç¾¤ + æœ¬åœ°ç¼“å­˜äºŒçº§é˜²æŠ¤

#### 3. æœç´¢å¼•æ“
- âŒ **Elasticsearch**: å•†å“æœç´¢ã€è®¢å•æ£€ç´¢
- âŒ **åˆ†è¯å™¨**: IKä¸­æ–‡åˆ†è¯
- âŒ **æœç´¢ä¼˜åŒ–**: åŒä¹‰è¯ã€æ‹¼éŸ³æœç´¢

#### 4. åº“å­˜ç³»ç»Ÿï¼ˆæ ¸å¿ƒï¼‰
- âŒ **é¢„å åº“å­˜**: Redisåˆ†å¸ƒå¼é”
- âŒ **åº“å­˜æ‰£å‡**: Luaè„šæœ¬åŸå­æ“ä½œ
- âŒ **åº“å­˜å¿«ç…§**: MVCCå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
- âŒ **å®‰å…¨åº“å­˜**: é¢„è­¦æœºåˆ¶

#### 5. å®šæ—¶è°ƒåº¦
- âŒ **XXL-Job**: åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦
- âŒ **è®¢å•è¶…æ—¶**: å»¶è¿Ÿæ¶ˆæ¯/æ—¶é—´è½®
- âŒ **æŠ¥è¡¨ç”Ÿæˆ**: å®šæ—¶ä»»åŠ¡

#### 6. æ•°æ®åŒæ­¥
- âŒ **Canal/Debezium**: MySQL binlogåŒæ­¥åˆ°ES
- âŒ **æ•°æ®æ¹–**: Hudi/Icebergï¼ˆå¯é€‰ï¼‰
- âŒ **å®æ—¶è®¡ç®—**: Flinkï¼ˆå¯é€‰ï¼‰

#### 7. ä¸šåŠ¡ä¸­å°
- âŒ **å•†å“ä¸­å¿ƒ**: SPU/SKUç®¡ç†
- âŒ **è®¢å•ä¸­å¿ƒ**: è®¢å•çŠ¶æ€æœº
- âŒ **åº“å­˜ä¸­å¿ƒ**: WMSä»“å‚¨ç®¡ç†
- âŒ **ç‰©æµä¸­å¿ƒ**: TMSè¿è¾“ç®¡ç†

---

## äºŒã€å¤§å‚ä¾›åº”é“¾ç³»ç»Ÿæ¶æ„å¯¹æ ‡

### é˜¿é‡Œèœé¸Ÿæ¶æ„ï¼ˆå‚è€ƒï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯åº”ç”¨å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ä¾›åº”å•†é—¨æˆ·â”‚  â”‚WMSä»“ç®¡  â”‚  â”‚TMSè¿è¾“  â”‚  â”‚æ•°æ®å¤§å± â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APIç½‘å…³å±‚ï¼ˆBFFï¼‰                        â”‚
â”‚  â”œâ”€ èº«ä»½è®¤è¯  â”œâ”€ é™æµç†”æ–­  â”œâ”€ è·¯ç”±èšåˆ  â”œâ”€ ç°åº¦å‘å¸ƒ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡ä¸­å°å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚å•†å“ä¸­å¿ƒ  â”‚  â”‚è®¢å•ä¸­å¿ƒ  â”‚  â”‚åº“å­˜ä¸­å¿ƒ  â”‚  â”‚ç‰©æµä¸­å¿ƒ  â”‚   â”‚
â”‚  â”‚(SPU/SKU) â”‚  â”‚(çŠ¶æ€æœº)  â”‚  â”‚(æ‰£å‡é”)  â”‚  â”‚(è·¯ç”±ç®—)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚é‡‡è´­ä¸­å¿ƒ  â”‚  â”‚ä¾›åº”å•†ä¸­å¿ƒâ”‚  â”‚ç»“ç®—ä¸­å¿ƒ  â”‚  â”‚æŠ¥è¡¨ä¸­å¿ƒ  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®è®¿é—®å±‚                              â”‚
â”‚  â”œâ”€ è¯»å†™åˆ†ç¦»  â”œâ”€ åˆ†åº“åˆ†è¡¨  â”œâ”€ ç¼“å­˜ç­–ç•¥  â”œâ”€ æœç´¢å¼•æ“        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åŸºç¡€è®¾æ–½å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚MySQLé›†ç¾¤ â”‚  â”‚Redisé›†ç¾¤ â”‚  â”‚ESé›†ç¾¤    â”‚  â”‚Kafkaé›†ç¾¤ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº¬ä¸œä¾›åº”é“¾æ ¸å¿ƒç‰¹ç‚¹

**æŠ€æœ¯ç‰¹ç‚¹:**
1. **å¼‚åœ°å¤šæ´»**: å¤šæœºæˆ¿å®¹ç¾ï¼ˆåŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·ï¼‰
2. **å¼¹æ€§ä¼¸ç¼©**: K8sè‡ªåŠ¨æ‰©å®¹
3. **æ™ºèƒ½ç®—æ³•**: è·¯å¾„è§„åˆ’ï¼ˆTSPç®—æ³•ï¼‰ã€åº“å­˜é¢„æµ‹ï¼ˆLSTMï¼‰
4. **å®æ—¶è®¡ç®—**: Flinkæµå¤„ç†è®¢å•ã€åº“å­˜

**ä¸šåŠ¡ç‰¹ç‚¹:**
1. **211é™æ—¶è¾¾**: ç²¾å‡†æ—¶æ•ˆæ‰¿è¯º
2. **æ™ºèƒ½è°ƒåº¦**: åŸºäºAIçš„è¿åŠ›è°ƒåº¦
3. **å…¨ç¨‹å¯è§†**: ä»ä¸‹å•åˆ°ç­¾æ”¶å®æ—¶è¿½è¸ª

---

## ä¸‰ã€ä¾›åº”é“¾ç³»ç»ŸæŠ€æœ¯å®Œå–„æ–¹æ¡ˆ

### 3.1 åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ â­â­â­â­â­

#### æ–¹æ¡ˆä¸€: Seata ATæ¨¡å¼ï¼ˆæ¨èï¼‰

**ä¸ºä»€ä¹ˆé€‰æ‹©Seata:**
- é˜¿é‡Œå¼€æºï¼Œç»è¿‡åŒ11éªŒè¯
- å¯¹ä¸šåŠ¡ä»£ç ä¾µå…¥å°ï¼Œåªéœ€åŠ @GlobalTransactional
- æ”¯æŒMySQLã€Oracleã€PostgreSQL

**é›†æˆæ­¥éª¤:**

```xml
<!-- pom.xml -->
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>2.0.0</version>
</dependency>
```

```yaml
# application.yaml
seata:
  enabled: true
  application-id: scm-order-service
  tx-service-group: scm-tx-group
  registry:
    type: nacos
    nacos:
      server-addr: ${spring.cloud.nacos.server-addr}
      group: SEATA_GROUP
  config:
    type: nacos
```

```java
// è®¢å•æœåŠ¡
@Service
public class OrderService {

    @Autowired
    private InventoryServiceClient inventoryClient;  // Dubbo RPC

    @Autowired
    private PaymentServiceClient paymentClient;

    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public Order createOrder(OrderDTO dto) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        Order order = new Order();
        order.setUserId(dto.getUserId());
        order.setAmount(dto.getAmount());
        orderMapper.insert(order);

        // 2. RPCè°ƒç”¨åº“å­˜æœåŠ¡æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹äº‹åŠ¡ï¼‰
        inventoryClient.deduct(dto.getSkuId(), dto.getQuantity());

        // 3. RPCè°ƒç”¨æ”¯ä»˜æœåŠ¡åˆ›å»ºæ”¯ä»˜å•ï¼ˆè¿œç¨‹äº‹åŠ¡ï¼‰
        paymentClient.createPayment(order.getId(), dto.getAmount());

        // ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
        return order;
    }
}
```

**æ•°æ®åº“å‡†å¤‡ï¼ˆæ¯ä¸ªåº“éƒ½è¦ï¼‰:**
```sql
-- Seata UNDO_LOGè¡¨
CREATE TABLE IF NOT EXISTS `undo_log`
(
    `branch_id`     BIGINT       NOT NULL COMMENT 'branch transaction id',
    `xid`           VARCHAR(128) NOT NULL COMMENT 'global transaction id',
    `context`       VARCHAR(128) NOT NULL COMMENT 'undo_log context',
    `rollback_info` LONGBLOB     NOT NULL COMMENT 'rollback info',
    `log_status`    INT(11)      NOT NULL COMMENT '0:normal status,1:defense status',
    `log_created`   DATETIME(6)  NOT NULL COMMENT 'create datetime',
    `log_modified`  DATETIME(6)  NOT NULL COMMENT 'modify datetime',
    UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)
) ENGINE = InnoDB COMMENT ='AT transaction mode undo table';
```

#### æ–¹æ¡ˆäºŒ: æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰

**é€‚ç”¨åœºæ™¯:** å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œå¯ä»¥æ¥å—çŸ­æš‚ä¸ä¸€è‡´

```java
@Service
public class OrderService {

    @Transactional
    public void createOrder(OrderDTO dto) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        orderMapper.insert(order);

        // 2. å†™å…¥æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆåŒä¸€ä¸ªäº‹åŠ¡ï¼‰
        LocalMessage msg = LocalMessage.builder()
            .bizId(order.getId())
            .topic("order.created")
            .payload(JsonUtils.toJson(order))
            .status(MessageStatus.PENDING)
            .maxRetry(3)
            .build();
        messageMapper.insert(msg);

        // 3. äº‹åŠ¡æäº¤åï¼Œå®šæ—¶ä»»åŠ¡ä¼šæ‰«ææ¶ˆæ¯è¡¨å‘é€åˆ°MQ
    }
}

// å®šæ—¶ä»»åŠ¡æ‰«æå¹¶å‘é€
@Component
public class MessageScanJob {

    @Scheduled(fixedDelay = 1000)  // æ¯ç§’æ‰«æä¸€æ¬¡
    public void scanAndSend() {
        List<LocalMessage> messages = messageMapper.selectPending(100);

        for (LocalMessage msg : messages) {
            try {
                // å‘é€åˆ°MQ
                kafkaTemplate.send(msg.getTopic(), msg.getPayload());

                // æ ‡è®°ä¸ºå·²å‘é€
                msg.setStatus(MessageStatus.SENT);
                messageMapper.updateById(msg);

            } catch (Exception e) {
                // é‡è¯•æ¬¡æ•°+1
                msg.setRetryCount(msg.getRetryCount() + 1);
                if (msg.getRetryCount() >= msg.getMaxRetry()) {
                    msg.setStatus(MessageStatus.FAILED);
                }
                messageMapper.updateById(msg);
            }
        }
    }
}
```

### 3.2 åº“å­˜ç³»ç»Ÿè®¾è®¡ï¼ˆæ ¸å¿ƒç«äº‰åŠ›ï¼‰ â­â­â­â­â­

#### 3.2.1 Redis + Lua åŸå­æ‰£å‡

```lua
-- deduct_inventory.lua
local key = KEYS[1]                -- åº“å­˜key: stock:sku:123
local quantity = tonumber(ARGV[1]) -- æ‰£å‡æ•°é‡

local stock = tonumber(redis.call('GET', key) or '0')

if stock >= quantity then
    redis.call('DECRBY', key, quantity)
    return 1  -- æˆåŠŸ
else
    return 0  -- åº“å­˜ä¸è¶³
end
```

```java
@Service
public class InventoryService {

    @Autowired
    private StringRedisTemplate redisTemplate;

    @Autowired
    private DefaultRedisScript<Long> deductScript;

    public boolean deductStock(Long skuId, Integer quantity) {
        String key = "stock:sku:" + skuId;

        Long result = redisTemplate.execute(
            deductScript,
            Collections.singletonList(key),
            quantity.toString()
        );

        if (result != null && result == 1) {
            // æ‰£å‡æˆåŠŸï¼Œå¼‚æ­¥æ›´æ–°æ•°æ®åº“
            asyncUpdateDatabase(skuId, quantity);
            return true;
        }

        return false;
    }

    @Async
    public void asyncUpdateDatabase(Long skuId, Integer quantity) {
        inventoryMapper.deduct(skuId, quantity);
    }
}
```

#### 3.2.2 é¢„å åº“å­˜ + å®šæ—¶é‡Šæ”¾

```java
@Service
public class StockReservationService {

    public String reserveStock(Long skuId, Integer quantity, Long orderId) {
        String reservationId = UUIDv7Util.generate();

        // 1. æ‰£å‡å¯ç”¨åº“å­˜
        boolean success = inventoryService.deductStock(skuId, quantity);
        if (!success) {
            throw new StockInsufficientException("åº“å­˜ä¸è¶³");
        }

        // 2. è®°å½•é¢„å è®°å½•ï¼ˆæ•°æ®åº“ï¼‰
        StockReservation reservation = StockReservation.builder()
            .reservationId(reservationId)
            .skuId(skuId)
            .quantity(quantity)
            .orderId(orderId)
            .expireTime(LocalDateTime.now().plusMinutes(15))
            .status(ReservationStatus.RESERVED)
            .build();
        reservationMapper.insert(reservation);

        // 3. Redisè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆåŒé‡ä¿é™©ï¼‰
        redisTemplate.opsForValue().set(
            "reservation:" + reservationId,
            quantity.toString(),
            15,
            TimeUnit.MINUTES
        );

        // 4. å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼ˆ15åˆ†é’Ÿåæ£€æŸ¥æ˜¯å¦éœ€è¦é‡Šæ”¾ï¼‰
        RabbitMessage msg = RabbitMessage.builder()
            .body(reservationId)
            .delay(15 * 60 * 1000)  // 15åˆ†é’Ÿ
            .build();
        rabbitTemplate.convertAndSend("stock.release.delayed", msg);

        return reservationId;
    }

    // ç›‘å¬å»¶è¿Ÿæ¶ˆæ¯
    @RabbitListener(queues = "stock.release.queue")
    public void handleStockRelease(String reservationId) {
        StockReservation reservation = reservationMapper.selectByReservationId(reservationId);

        // å¦‚æœé¢„å è®°å½•è¿˜æ˜¯RESERVEDçŠ¶æ€ï¼Œè¯´æ˜è®¢å•æœªæ”¯ä»˜ï¼Œéœ€è¦é‡Šæ”¾
        if (reservation.getStatus() == ReservationStatus.RESERVED) {
            // å›é€€åº“å­˜
            inventoryService.increaseStock(reservation.getSkuId(), reservation.getQuantity());

            // æ›´æ–°é¢„å è®°å½•
            reservation.setStatus(ReservationStatus.RELEASED);
            reservationMapper.updateById(reservation);
        }
    }

    // ç¡®è®¤å ç”¨ï¼ˆè®¢å•æ”¯ä»˜æˆåŠŸåè°ƒç”¨ï¼‰
    public void confirmReservation(String reservationId) {
        StockReservation reservation = reservationMapper.selectByReservationId(reservationId);
        reservation.setStatus(ReservationStatus.CONFIRMED);
        reservationMapper.updateById(reservation);
    }
}
```

### 3.3 è®¢å•çŠ¶æ€æœºï¼ˆç¾å›¢æ–¹æ¡ˆï¼‰ â­â­â­â­

```xml
<dependency>
    <groupId>org.springframework.statemachine</groupId>
    <artifactId>spring-statemachine-core</artifactId>
    <version>3.2.0</version>
</dependency>
```

```java
// è®¢å•çŠ¶æ€æšä¸¾
public enum OrderStatus {
    PENDING_PAYMENT,    // å¾…æ”¯ä»˜
    PAID,               // å·²æ”¯ä»˜
    PENDING_SHIP,       // å¾…å‘è´§
    SHIPPED,            // å·²å‘è´§
    IN_TRANSIT,         // è¿è¾“ä¸­
    DELIVERED,          // å·²é€è¾¾
    COMPLETED,          // å·²å®Œæˆ
    CANCELLED           // å·²å–æ¶ˆ
}

// è®¢å•äº‹ä»¶æšä¸¾
public enum OrderEvent {
    PAYMENT_SUCCESS,      // æ”¯ä»˜æˆåŠŸ
    WAREHOUSE_ALLOCATED,  // ä»“åº“åˆ†é…
    SHIP_OUT,             // å‘è´§
    TRANSIT_UPDATE,       // ç‰©æµæ›´æ–°
    ARRIVE_DESTINATION,   // åˆ°è¾¾ç›®çš„åœ°
    CONFIRM_RECEIVED,     // ç¡®è®¤æ”¶è´§
    CANCEL                // å–æ¶ˆè®¢å•
}

@Configuration
@EnableStateMachine
public class OrderStateMachineConfig extends StateMachineConfigurerAdapter<OrderStatus, OrderEvent> {

    @Override
    public void configure(StateMachineStateConfigurer<OrderStatus, OrderEvent> states) throws Exception {
        states
            .withStates()
            .initial(OrderStatus.PENDING_PAYMENT)
            .states(EnumSet.allOf(OrderStatus.class));
    }

    @Override
    public void configure(StateMachineTransitionConfigurer<OrderStatus, OrderEvent> transitions) throws Exception {
        transitions
            // å¾…æ”¯ä»˜ -> å·²æ”¯ä»˜
            .withExternal()
                .source(OrderStatus.PENDING_PAYMENT)
                .target(OrderStatus.PAID)
                .event(OrderEvent.PAYMENT_SUCCESS)
                .guard(paymentGuard())
                .action(afterPaymentAction())
            .and()
            // å·²æ”¯ä»˜ -> å¾…å‘è´§
            .withExternal()
                .source(OrderStatus.PAID)
                .target(OrderStatus.PENDING_SHIP)
                .event(OrderEvent.WAREHOUSE_ALLOCATED)
            .and()
            // å¾…å‘è´§ -> å·²å‘è´§
            .withExternal()
                .source(OrderStatus.PENDING_SHIP)
                .target(OrderStatus.SHIPPED)
                .event(OrderEvent.SHIP_OUT)
                .action(notifyLogisticsAction())
            .and()
            // å·²å‘è´§ -> è¿è¾“ä¸­
            .withExternal()
                .source(OrderStatus.SHIPPED)
                .target(OrderStatus.IN_TRANSIT)
                .event(OrderEvent.TRANSIT_UPDATE)
            .and()
            // è¿è¾“ä¸­ -> å·²é€è¾¾
            .withExternal()
                .source(OrderStatus.IN_TRANSIT)
                .target(OrderStatus.DELIVERED)
                .event(OrderEvent.ARRIVE_DESTINATION)
            .and()
            // å·²é€è¾¾ -> å·²å®Œæˆ
            .withExternal()
                .source(OrderStatus.DELIVERED)
                .target(OrderStatus.COMPLETED)
                .event(OrderEvent.CONFIRM_RECEIVED);
    }

    @Bean
    public Guard<OrderStatus, OrderEvent> paymentGuard() {
        return context -> {
            // éªŒè¯æ”¯ä»˜æ˜¯å¦æˆåŠŸ
            Long orderId = (Long) context.getMessage().getHeaders().get("orderId");
            Payment payment = paymentService.getByOrderId(orderId);
            return payment != null && payment.getStatus() == PaymentStatus.SUCCESS;
        };
    }

    @Bean
    public Action<OrderStatus, OrderEvent> afterPaymentAction() {
        return context -> {
            Long orderId = (Long) context.getMessage().getHeaders().get("orderId");

            // 1. ç¡®è®¤åº“å­˜é¢„å 
            Order order = orderMapper.selectById(orderId);
            stockReservationService.confirmReservation(order.getReservationId());

            // 2. åˆ†é…ä»“åº“
            warehouseService.allocate(orderId);

            // 3. å‘é€é€šçŸ¥
            notificationService.send(order.getUserId(), "æ”¯ä»˜æˆåŠŸï¼Œæ­£åœ¨å‡†å¤‡å‘è´§");
        };
    }

    @Bean
    public Action<OrderStatus, OrderEvent> notifyLogisticsAction() {
        return context -> {
            Long orderId = (Long) context.getMessage().getHeaders().get("orderId");

            // è°ƒç”¨ç‰©æµæœåŠ¡åˆ›å»ºè¿å•
            logisticsService.createWaybill(orderId);
        };
    }
}

// ä½¿ç”¨çŠ¶æ€æœº
@Service
public class OrderFSMService {

    @Autowired
    private StateMachine<OrderStatus, OrderEvent> stateMachine;

    public void fireEvent(Long orderId, OrderEvent event) {
        stateMachine.sendEvent(MessageBuilder
            .withPayload(event)
            .setHeader("orderId", orderId)
            .build());
    }
}
```

### 3.4 æœç´¢å¼•æ“é›†æˆï¼ˆElasticsearchï¼‰ â­â­â­â­

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

```yaml
spring:
  elasticsearch:
    uris: http://localhost:9200
    username: elastic
    password: elastic
```

```java
// å•†å“æœç´¢æ–‡æ¡£
@Document(indexName = "products")
public class ProductDocument {

    @Id
    private Long id;

    @Field(type = FieldType.Text, analyzer = "ik_max_word", searchAnalyzer = "ik_smart")
    private String name;

    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String description;

    @Field(type = FieldType.Keyword)
    private String category;

    @Field(type = FieldType.Keyword)
    private String brand;

    @Field(type = FieldType.Double)
    private BigDecimal price;

    @Field(type = FieldType.Integer)
    private Integer stock;

    @Field(type = FieldType.Integer)
    private Integer sales;  // é”€é‡

    @Field(type = FieldType.Date, format = DateFormat.date_time)
    private LocalDateTime createTime;
}

// Repository
@Repository
public interface ProductSearchRepository extends ElasticsearchRepository<ProductDocument, Long> {

    // å…³é”®è¯æœç´¢
    List<ProductDocument> findByNameContaining(String keyword);

    // ä»·æ ¼åŒºé—´æœç´¢
    List<ProductDocument> findByPriceBetween(BigDecimal minPrice, BigDecimal maxPrice);

    // å¤æ‚æŸ¥è¯¢
    @Query("{\"bool\": {\"must\": [{\"match\": {\"name\": \"?0\"}}], \"filter\": [{\"range\": {\"price\": {\"gte\": ?1, \"lte\": ?2}}}]}}")
    List<ProductDocument> searchByNameAndPriceRange(String name, BigDecimal minPrice, BigDecimal maxPrice);
}

// Service
@Service
public class ProductSearchService {

    @Autowired
    private ElasticsearchRestTemplate elasticsearchTemplate;

    public Page<ProductDocument> search(ProductSearchDTO searchDTO) {
        // æ„å»ºæŸ¥è¯¢
        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();

        // 1. å…³é”®è¯æœç´¢ï¼ˆnameå’Œdescriptionï¼‰
        if (StringUtils.isNotBlank(searchDTO.getKeyword())) {
            boolQuery.should(QueryBuilders.matchQuery("name", searchDTO.getKeyword()).boost(2.0f));
            boolQuery.should(QueryBuilders.matchQuery("description", searchDTO.getKeyword()));
        }

        // 2. ç±»ç›®è¿‡æ»¤
        if (StringUtils.isNotBlank(searchDTO.getCategory())) {
            boolQuery.filter(QueryBuilders.termQuery("category", searchDTO.getCategory()));
        }

        // 3. ä»·æ ¼åŒºé—´
        if (searchDTO.getMinPrice() != null || searchDTO.getMaxPrice() != null) {
            RangeQueryBuilder rangeQuery = QueryBuilders.rangeQuery("price");
            if (searchDTO.getMinPrice() != null) {
                rangeQuery.gte(searchDTO.getMinPrice());
            }
            if (searchDTO.getMaxPrice() != null) {
                rangeQuery.lte(searchDTO.getMaxPrice());
            }
            boolQuery.filter(rangeQuery);
        }

        // 4. æ’åº
        SortBuilder<?> sortBuilder = switch (searchDTO.getSort()) {
            case "price_asc" -> SortBuilders.fieldSort("price").order(SortOrder.ASC);
            case "price_desc" -> SortBuilders.fieldSort("price").order(SortOrder.DESC);
            case "sales" -> SortBuilders.fieldSort("sales").order(SortOrder.DESC);
            default -> SortBuilders.scoreSort();  // ç›¸å…³æ€§æ’åº
        };

        // 5. æ‰§è¡ŒæŸ¥è¯¢
        NativeSearchQuery searchQuery = new NativeSearchQueryBuilder()
            .withQuery(boolQuery)
            .withSorts(sortBuilder)
            .withPageable(PageRequest.of(searchDTO.getPage(), searchDTO.getSize()))
            .build();

        SearchHits<ProductDocument> searchHits = elasticsearchTemplate.search(searchQuery, ProductDocument.class);

        return SearchHitSupport.searchPageFor(searchHits, searchQuery.getPageable());
    }
}
```

**æ•°æ®åŒæ­¥ï¼ˆCanalï¼‰:**

```java
@Component
public class ProductCanalListener extends AbstractCanalClient {

    @Autowired
    private ProductSearchRepository searchRepository;

    @Override
    protected void processEntry(CanalEntry.Entry entry) {
        CanalEntry.RowChange rowChange = CanalEntry.RowChange.parseFrom(entry.getStoreValue());

        for (CanalEntry.RowData rowData : rowChange.getRowDatasList()) {
            if (entry.getHeader().getTableName().equals("t_product")) {

                if (rowChange.getEventType() == CanalEntry.EventType.INSERT ||
                    rowChange.getEventType() == CanalEntry.EventType.UPDATE) {

                    // åŒæ­¥åˆ°ES
                    ProductDocument doc = convertToDocument(rowData);
                    searchRepository.save(doc);

                } else if (rowChange.getEventType() == CanalEntry.EventType.DELETE) {

                    // ä»ESåˆ é™¤
                    Long id = Long.parseLong(getColumnValue(rowData, "id"));
                    searchRepository.deleteById(id);
                }
            }
        }
    }
}
```

### 3.5 åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ï¼ˆXXL-Jobï¼‰ â­â­â­â­

```xml
<dependency>
    <groupId>com.xuxueli</groupId>
    <artifactId>xxl-job-core</artifactId>
    <version>2.4.0</version>
</dependency>
```

```yaml
xxl:
  job:
    admin:
      addresses: http://localhost:8080/xxl-job-admin
    executor:
      appname: scm-order-executor
      port: 9999
```

```java
@Component
public class OrderJobHandler {

    // æ¯5åˆ†é’Ÿæ‰«æè¶…æ—¶æœªæ”¯ä»˜è®¢å•
    @XxlJob("cancelTimeoutOrderJob")
    public void cancelTimeoutOrder() {
        log.info("å¼€å§‹æ‰«æè¶…æ—¶æœªæ”¯ä»˜è®¢å•...");

        LocalDateTime timeout = LocalDateTime.now().minusMinutes(15);

        List<Order> timeoutOrders = orderMapper.selectList(
            new LambdaQueryWrapper<Order>()
                .eq(Order::getStatus, OrderStatus.PENDING_PAYMENT)
                .lt(Order::getCreateTime, timeout)
                .last("LIMIT 1000")  // åˆ†æ‰¹å¤„ç†
        );

        for (Order order : timeoutOrders) {
            try {
                // 1. å–æ¶ˆè®¢å•
                order.setStatus(OrderStatus.CANCELLED);
                order.setCancelReason("æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ");
                orderMapper.updateById(order);

                // 2. é‡Šæ”¾åº“å­˜
                if (StringUtils.isNotBlank(order.getReservationId())) {
                    stockReservationService.releaseReservation(order.getReservationId());
                }

                // 3. å‘é€é€šçŸ¥
                notificationService.send(order.getUserId(), "è®¢å•å·²è¶…æ—¶å–æ¶ˆ");

            } catch (Exception e) {
                log.error("å–æ¶ˆè®¢å•å¤±è´¥: orderId={}", order.getId(), e);
            }
        }

        log.info("è¶…æ—¶è®¢å•å¤„ç†å®Œæˆï¼Œå…±å¤„ç†{}ç¬”", timeoutOrders.size());
    }

    // æ¯å¤©å‡Œæ™¨2ç‚¹ç”Ÿæˆé”€å”®æŠ¥è¡¨
    @XxlJob("generateSalesReportJob")
    public void generateSalesReport() {
        LocalDate yesterday = LocalDate.now().minusDays(1);

        // èšåˆæ˜¨æ—¥é”€å”®æ•°æ®
        SalesReport report = reportService.generateDailySalesReport(yesterday);

        // ä¿å­˜åˆ°æ•°æ®åº“
        reportMapper.insert(report);

        // å‘é€åˆ°ç®¡ç†å‘˜é‚®ç®±
        emailService.sendSalesReport(report);
    }

    // æ¯å°æ—¶åŒæ­¥åº“å­˜åˆ°ES
    @XxlJob("syncInventoryToESJob")
    public void syncInventoryToES() {
        // Canalå¯èƒ½æœ‰å»¶è¿Ÿï¼Œå®šæ—¶å…¨é‡åŒæ­¥ä¸€æ¬¡
        List<Inventory> inventories = inventoryMapper.selectList(null);

        for (Inventory inventory : inventories) {
            ProductDocument doc = searchRepository.findById(inventory.getSkuId()).orElse(null);
            if (doc != null) {
                doc.setStock(inventory.getAvailableStock());
                searchRepository.save(doc);
            }
        }
    }
}
```

---

## å››ã€å¾®æœåŠ¡æ‹†åˆ†è®¾è®¡ï¼ˆDDDé¢†åŸŸé©±åŠ¨ï¼‰

### 4.1 æœåŠ¡åˆ’åˆ†

```
scm-platform/
â”œâ”€â”€ scm-gateway/              # APIç½‘å…³ï¼ˆå·²æœ‰ï¼‰
â”œâ”€â”€ scm-auth/                 # è®¤è¯æˆæƒæœåŠ¡ï¼ˆå·²æœ‰ï¼‰
â”œâ”€â”€ scm-user/                 # ç”¨æˆ·æœåŠ¡ï¼ˆå·²æœ‰ï¼‰
â”‚
â”œâ”€â”€ scm-product/              # å•†å“æœåŠ¡
â”‚   â”œâ”€â”€ api/                  # Dubboæ¥å£
â”‚   â””â”€â”€ service/              # æœåŠ¡å®ç°
â”‚       â”œâ”€â”€ domain/           # é¢†åŸŸæ¨¡å‹ï¼ˆSPU/SKUï¼‰
â”‚       â”œâ”€â”€ application/      # åº”ç”¨æœåŠ¡
â”‚       â””â”€â”€ infrastructure/   # åŸºç¡€è®¾æ–½
â”‚
â”œâ”€â”€ scm-inventory/            # åº“å­˜æœåŠ¡ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ domain/           # åº“å­˜é¢†åŸŸï¼ˆé¢„å ã€æ‰£å‡ï¼‰
â”‚       â”œâ”€â”€ application/
â”‚       â””â”€â”€ infrastructure/
â”‚
â”œâ”€â”€ scm-order/                # è®¢å•æœåŠ¡
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ domain/           # è®¢å•èšåˆæ ¹ï¼ˆçŠ¶æ€æœºï¼‰
â”‚       â”œâ”€â”€ application/
â”‚       â””â”€â”€ infrastructure/
â”‚
â”œâ”€â”€ scm-warehouse/            # ä»“å‚¨æœåŠ¡ï¼ˆWMSï¼‰
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ domain/           # å…¥åº“ã€å‡ºåº“ã€ç›˜ç‚¹
â”‚       â”œâ”€â”€ application/
â”‚       â””â”€â”€ infrastructure/
â”‚
â”œâ”€â”€ scm-logistics/            # ç‰©æµæœåŠ¡ï¼ˆTMSï¼‰
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ domain/           # è¿å•ã€é…é€
â”‚       â”œâ”€â”€ application/
â”‚       â””â”€â”€ infrastructure/
â”‚
â”œâ”€â”€ scm-purchase/             # é‡‡è´­æœåŠ¡
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ domain/           # é‡‡è´­å•ã€ä¾›åº”å•†
â”‚       â”œâ”€â”€ application/
â”‚       â””â”€â”€ infrastructure/
â”‚
â”œâ”€â”€ scm-supplier/             # ä¾›åº”å•†æœåŠ¡
â”œâ”€â”€ scm-settlement/           # ç»“ç®—æœåŠ¡
â”œâ”€â”€ scm-report/               # æŠ¥è¡¨æœåŠ¡
â”‚
â””â”€â”€ scm-common/               # å…¬å…±æ¨¡å—ï¼ˆä»NewNearSyncå¤åˆ¶ï¼‰
    â”œâ”€â”€ common-core/
    â”œâ”€â”€ common-data/
    â”œâ”€â”€ common-security/
    â””â”€â”€ common-mq/
```

### 4.2 æ•°æ®åº“åˆ†åº“ç­–ç•¥

```yaml
# ShardingSphereé…ç½®ç¤ºä¾‹
spring:
  shardingsphere:
    datasource:
      names: master0,master1,slave0,slave1

    rules:
      sharding:
        tables:
          # è®¢å•è¡¨ï¼šæŒ‰ç”¨æˆ·IDå–æ¨¡åˆ†16å¼ è¡¨
          t_order:
            actual-data-nodes: master${0..1}.t_order_${0..15}
            database-strategy:
              standard:
                sharding-column: user_id
                sharding-algorithm-name: order-db-mod
            table-strategy:
              standard:
                sharding-column: user_id
                sharding-algorithm-name: order-table-mod

          # åº“å­˜è¡¨ï¼šæŒ‰SKU IDå–æ¨¡åˆ†8å¼ è¡¨
          t_inventory:
            actual-data-nodes: master${0..1}.t_inventory_${0..7}
            table-strategy:
              standard:
                sharding-column: sku_id
                sharding-algorithm-name: inventory-mod

        sharding-algorithms:
          order-db-mod:
            type: MOD
            props:
              sharding-count: 2

          order-table-mod:
            type: INLINE
            props:
              algorithm-expression: t_order_${user_id % 16}

          inventory-mod:
            type: MOD
            props:
              sharding-count: 8
```

---

## äº”ã€æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 5.1 ä¸‰çº§ç¼“å­˜æ¶æ„

```java
@Service
public class ProductService {

    // L1: JVMæœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
    private LoadingCache<Long, Product> localCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .recordStats()  // è®°å½•å‘½ä¸­ç‡
        .build(this::loadFromRedis);

    // L2: Redisç¼“å­˜
    @Cacheable(value = "product", key = "#id", unless = "#result == null")
    public Product getFromRedis(Long id) {
        // L3: æ•°æ®åº“
        return productMapper.selectById(id);
    }

    public Product getProduct(Long id) {
        try {
            // å…ˆæŸ¥L1
            return localCache.get(id);
        } catch (Exception e) {
            // L1æœªå‘½ä¸­ï¼Œç›´æ¥æŸ¥åº“
            return getFromRedis(id);
        }
    }

    private Product loadFromRedis(Long id) {
        return getFromRedis(id);
    }
}
```

### 5.2 çƒ­ç‚¹æ•°æ®ä¿æŠ¤

```java
@Component
public class HotspotProtector {

    // çƒ­ç‚¹è®¡æ•°å™¨
    private final LoadingCache<String, AtomicLong> hotspotCounter = Caffeine.newBuilder()
        .expireAfterWrite(10, TimeUnit.SECONDS)
        .build(key -> new AtomicLong(0));

    // çƒ­ç‚¹æ•°æ®æœ¬åœ°ç¼“å­˜
    private final LoadingCache<String, Object> hotspotCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(30, TimeUnit.SECONDS)
        .build(key -> null);

    public boolean isHotspot(String key) {
        AtomicLong counter = hotspotCounter.get(key);
        return counter.incrementAndGet() > 1000;  // 10ç§’è¶…è¿‡1000æ¬¡
    }

    @Around("@annotation(Hotspot)")
    public Object protectHotspot(ProceedingJoinPoint pjp) throws Throwable {
        String key = generateKey(pjp);

        // åˆ¤æ–­æ˜¯å¦ä¸ºçƒ­ç‚¹
        if (isHotspot(key)) {
            // çƒ­ç‚¹æ•°æ®ï¼Œä¼˜å…ˆè¿”å›æœ¬åœ°ç¼“å­˜
            Object cached = hotspotCache.getIfPresent(key);
            if (cached != null) {
                return cached;
            }
        }

        // æ­£å¸¸æ‰§è¡Œ
        Object result = pjp.proceed();

        // ç¼“å­˜ç»“æœ
        if (result != null) {
            hotspotCache.put(key, result);
        }

        return result;
    }
}
```

### 5.3 é™æµé™çº§ï¼ˆç§’æ€åœºæ™¯ï¼‰

```java
@RestController
@RequestMapping("/api/seckill")
public class SeckillController {

    @Autowired
    private SeckillService seckillService;

    // é™æµ: æ¯ç§’10000ä¸ªè¯·æ±‚
    @SentinelResource(
        value = "seckill",
        blockHandler = "handleBlock",
        fallback = "handleFallback"
    )
    @RateLimiter(name = "seckill", rateLimit = 10000)
    @PostMapping("/order")
    public ApiResponse<SeckillOrder> createSeckillOrder(@RequestBody SeckillDTO dto) {
        return ApiResponse.success(seckillService.createOrder(dto));
    }

    // é™æµå…œåº•
    public ApiResponse<SeckillOrder> handleBlock(SeckillDTO dto, BlockException ex) {
        return ApiResponse.error("æ´»åŠ¨å¤ªç«çˆ†ï¼Œè¯·ç¨åå†è¯•");
    }

    // é™çº§å¤„ç†ï¼ˆå¼‚æ­¥åŒ–ï¼‰
    public ApiResponse<SeckillOrder> handleFallback(SeckillDTO dto, Throwable ex) {
        // å†™å…¥MQå¼‚æ­¥å¤„ç†
        kafkaTemplate.send("seckill.async", dto);
        return ApiResponse.success("è®¢å•å·²æäº¤ï¼Œæ­£åœ¨æ’é˜Ÿå¤„ç†...");
    }
}

// ç§’æ€æœåŠ¡å®ç°
@Service
public class SeckillService {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    public SeckillOrder createOrder(SeckillDTO dto) {
        Long userId = dto.getUserId();
        Long skuId = dto.getSkuId();

        // 1. é˜²é‡å¤ä¸‹å•ï¼ˆRedis SETNXï¼‰
        String dedupeKey = "seckill:order:" + userId + ":" + skuId;
        Boolean setSuccess = redisTemplate.opsForValue().setIfAbsent(
            dedupeKey,
            "1",
            10,
            TimeUnit.MINUTES
        );
        if (Boolean.FALSE.equals(setSuccess)) {
            throw new BusinessException("æ‚¨å·²ç»å‚ä¸è¿‡è¯¥æ´»åŠ¨");
        }

        // 2. Luaè„šæœ¬åŸå­æ‰£å‡åº“å­˜
        boolean deducted = inventoryService.deductStock(skuId, 1);
        if (!deducted) {
            throw new BusinessException("å•†å“å·²å”®ç½„");
        }

        // 3. åˆ›å»ºè®¢å•ï¼ˆå¼‚æ­¥ï¼‰
        SeckillOrder order = new SeckillOrder();
        order.setUserId(userId);
        order.setSkuId(skuId);
        order.setStatus(OrderStatus.PENDING_PAYMENT);
        orderMapper.insert(order);

        // 4. å‘é€MQå¼‚æ­¥å¤„ç†åç»­æµç¨‹
        kafkaTemplate.send("order.created", order);

        return order;
    }
}
```

---

## å…­ã€ç›‘æ§å‘Šè­¦ä½“ç³»

### 6.1 ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§

```java
@Component
public class BusinessMetrics {

    @Autowired
    private MeterRegistry meterRegistry;

    // è®¢å•åˆ›å»ºæˆåŠŸç‡
    public void recordOrderCreate(boolean success) {
        Counter.builder("scm.order.create")
            .tag("status", success ? "success" : "fail")
            .description("è®¢å•åˆ›å»ºæ¬¡æ•°")
            .register(meterRegistry)
            .increment();
    }

    // åº“å­˜æ‰£å‡è€—æ—¶
    public void recordInventoryDeduct(long duration) {
        Timer.builder("scm.inventory.deduct.duration")
            .description("åº“å­˜æ‰£å‡è€—æ—¶")
            .register(meterRegistry)
            .record(duration, TimeUnit.MILLISECONDS);
    }

    // å®æ—¶åº“å­˜æ°´ä½
    public void recordStockLevel(Long skuId, Integer stock) {
        Gauge.builder("scm.stock.level", stock, Integer::intValue)
            .tag("sku_id", skuId.toString())
            .description("å®æ—¶åº“å­˜æ•°é‡")
            .register(meterRegistry);
    }

    // ç§’æ€æŠ¢è´­æˆåŠŸç‡
    public void recordSeckillSuccess(boolean success) {
        Counter.builder("scm.seckill.order")
            .tag("result", success ? "success" : "fail")
            .register(meterRegistry)
            .increment();
    }
}
```

### 6.2 å‘Šè­¦è§„åˆ™ï¼ˆPrometheus + AlertManagerï¼‰

```yaml
# prometheus_alerts.yaml
groups:
  - name: scm-business-alerts
    rules:
      # è®¢å•å¤±è´¥ç‡ > 5%
      - alert: HighOrderFailureRate
        expr: |
          sum(rate(scm_order_create_total{status="fail"}[5m]))
          /
          sum(rate(scm_order_create_total[5m]))
          > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "è®¢å•å¤±è´¥ç‡è¿‡é«˜"
          description: "æœ€è¿‘5åˆ†é’Ÿè®¢å•å¤±è´¥ç‡: {{ $value | humanizePercentage }}"

      # åº“å­˜ä¸è¶³å‘Šè­¦
      - alert: LowStockLevel
        expr: scm_stock_level < 100
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "SKU {{ $labels.sku_id }} åº“å­˜ä¸è¶³"
          description: "å½“å‰åº“å­˜: {{ $value }}"

      # åº“å­˜æ‰£å‡è€—æ—¶ > 500ms
      - alert: SlowInventoryDeduct
        expr: |
          histogram_quantile(0.99,
            sum(rate(scm_inventory_deduct_duration_bucket[5m])) by (le)
          ) > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "åº“å­˜æ‰£å‡å“åº”è¿‡æ…¢"
          description: "P99è€—æ—¶: {{ $value }}ms"

      # Seataäº‹åŠ¡å›æ»šç‡ > 10%
      - alert: HighTransactionRollbackRate
        expr: |
          sum(rate(seata_transaction_total{status="rollback"}[5m]))
          /
          sum(rate(seata_transaction_total[5m]))
          > 0.1
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "åˆ†å¸ƒå¼äº‹åŠ¡å›æ»šç‡è¿‡é«˜"
```

---

## ä¸ƒã€åˆ›å»ºæ–°ä»£ç åº“æ­¥éª¤

### æ­¥éª¤1: åˆ›å»ºGitHubä»“åº“

```bash
# 1. åˆ›å»ºæœ¬åœ°ç›®å½•
cd D:/ProgramProject
mkdir scm-platform
cd scm-platform

# 2. åˆå§‹åŒ–Git
git init

# 3. åˆ›å»ºREADME
cat > README.md << 'EOF'
# SCM Platform - ä¾›åº”é“¾ç®¡ç†ç³»ç»Ÿ

åŸºäº CommonPermissionsFramework æ„å»ºçš„ä¼ä¸šçº§ä¾›åº”é“¾ç®¡ç†å¹³å°

## æŠ€æœ¯æ ˆ

- Java 21
- Spring Boot 4.0.0
- Spring Cloud 2025.1.0
- Seata 2.0.0ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰
- XXL-Job 2.4.0ï¼ˆåˆ†å¸ƒå¼ä»»åŠ¡ï¼‰
- Elasticsearch 8.11.0ï¼ˆæœç´¢å¼•æ“ï¼‰

## æ ¸å¿ƒèƒ½åŠ›

- âœ… åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ï¼ˆSeataï¼‰
- âœ… é«˜å¹¶å‘åº“å­˜æ‰£å‡ï¼ˆRedis Luaï¼‰
- âœ… è®¢å•çŠ¶æ€æœºï¼ˆSpring StateMachineï¼‰
- âœ… å…¨æ–‡æœç´¢ï¼ˆElasticsearch + IKåˆ†è¯ï¼‰
- âœ… ä»»åŠ¡è°ƒåº¦ï¼ˆXXL-Jobï¼‰

## å¯¹æ ‡å¤§å‚

- é˜¿é‡Œèœé¸Ÿä¾›åº”é“¾
- äº¬ä¸œç‰©æµWMS
- ç¾å›¢é…é€ç³»ç»Ÿ
EOF

# 4. åˆ›å»º.gitignore
cat > .gitignore << 'EOF'
target/
*.class
.idea/
*.iml
*.log
EOF

# 5. åˆ›å»ºGitHubä»“åº“
gh repo create scm-platform --public --description "Enterprise Supply Chain Management Platform | ä¼ä¸šçº§ä¾›åº”é“¾ç®¡ç†å¹³å°"

# 6. æäº¤å¹¶æ¨é€
git add .
git commit -m "feat: åˆå§‹åŒ–ä¾›åº”é“¾ç®¡ç†å¹³å°é¡¹ç›®

- åŸºäºCommonPermissionsFramework v1.3.0
- é›†æˆSeataåˆ†å¸ƒå¼äº‹åŠ¡
- é›†æˆXXL-Jobä»»åŠ¡è°ƒåº¦
- é›†æˆElasticsearchæœç´¢å¼•æ“
- å¾®æœåŠ¡æ‹†åˆ†ï¼šå•†å“ã€åº“å­˜ã€è®¢å•ã€ä»“å‚¨ã€ç‰©æµ

å‚è€ƒæ¶æ„: é˜¿é‡Œèœé¸Ÿã€äº¬ä¸œç‰©æµã€ç¾å›¢é…é€"

git branch -M main
git remote add origin https://github.com/ä½ çš„ç”¨æˆ·å/scm-platform.git
git push -u origin main
```

### æ­¥éª¤2: å¤åˆ¶åŸºç¡€æ¡†æ¶

```bash
# ä»NewNearSyncå¤åˆ¶å…¬å…±æ¨¡å—
cp -r ../NewNearSync/common ./scm-common

# å¤åˆ¶ç½‘å…³
cp -r ../NewNearSync/gateway ./scm-gateway

# å¤åˆ¶è®¤è¯æœåŠ¡
cp -r ../NewNearSync/auth ./scm-auth

# å¤åˆ¶ç³»ç»ŸæœåŠ¡ï¼ˆæ”¹é€ ä¸ºç”¨æˆ·æœåŠ¡ï¼‰
cp -r ../NewNearSync/system ./scm-user
```

### æ­¥éª¤3: åˆ›å»ºçˆ¶POM

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.scm</groupId>
    <artifactId>scm-platform</artifactId>
    <version>1.0.0-SNAPSHOT</version>
    <packaging>pom</packaging>

    <name>SCM Platform</name>
    <description>Supply Chain Management Platform</description>

    <modules>
        <module>scm-common</module>
        <module>scm-gateway</module>
        <module>scm-auth</module>
        <module>scm-user</module>
        <module>scm-product</module>
        <module>scm-inventory</module>
        <module>scm-order</module>
        <module>scm-warehouse</module>
        <module>scm-logistics</module>
    </modules>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>4.0.0</version>
    </parent>

    <properties>
        <java.version>21</java.version>
        <spring-cloud.version>2025.1.0</spring-cloud.version>
        <spring-cloud-alibaba.version>2025.0.0.0</spring-cloud-alibaba.version>

        <!-- æ–°å¢ä¾èµ–ç‰ˆæœ¬ -->
        <seata.version>2.0.0</seata.version>
        <xxl-job.version>2.4.0</xxl-job.version>
        <elasticsearch.version>8.11.0</elasticsearch.version>
        <canal.version>1.1.7</canal.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <!-- Spring Cloud -->
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <!-- Seata åˆ†å¸ƒå¼äº‹åŠ¡ -->
            <dependency>
                <groupId>io.seata</groupId>
                <artifactId>seata-spring-boot-starter</artifactId>
                <version>${seata.version}</version>
            </dependency>

            <!-- XXL-Job ä»»åŠ¡è°ƒåº¦ -->
            <dependency>
                <groupId>com.xuxueli</groupId>
                <artifactId>xxl-job-core</artifactId>
                <version>${xxl-job.version}</version>
            </dependency>

            <!-- Elasticsearch -->
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
                <version>4.0.0</version>
            </dependency>

            <!-- Canal -->
            <dependency>
                <groupId>com.alibaba.otter</groupId>
                <artifactId>canal.client</artifactId>
                <version>${canal.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>
</project>
```

### æ­¥éª¤4: åˆ›å»ºæ ¸å¿ƒæœåŠ¡éª¨æ¶

```bash
# ä½¿ç”¨Maven Archetypeåˆ›å»ºæœåŠ¡æ¨¡å—
cd scm-platform

# åˆ›å»ºå•†å“æœåŠ¡
mvn archetype:generate \
    -DgroupId=com.scm \
    -DartifactId=scm-product \
    -DarchetypeArtifactId=maven-archetype-quickstart \
    -DinteractiveMode=false

# åˆ›å»ºåº“å­˜æœåŠ¡
mvn archetype:generate \
    -DgroupId=com.scm \
    -DartifactId=scm-inventory \
    -DarchetypeArtifactId=maven-archetype-quickstart \
    -DinteractiveMode=false

# åˆ›å»ºè®¢å•æœåŠ¡
mvn archetype:generate \
    -DgroupId=com.scm \
    -DartifactId=scm-order \
    -DarchetypeArtifactId=maven-archetype-quickstart \
    -DinteractiveMode=false
```

---

## å…«ã€é¡¹ç›®è·¯çº¿å›¾

### Phase 1: åŸºç¡€è®¾æ–½æ­å»ºï¼ˆ1-2å‘¨ï¼‰

**ç›®æ ‡:** å®ŒæˆæŠ€æœ¯é€‰å‹å’ŒåŸºç¡€æ¡†æ¶

- [x] ä»CommonPermissionsFrameworkå¤åˆ¶å¹¶æ”¹é€ å…¬å…±æ¨¡å—
- [ ] é›†æˆSeataåˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶
- [ ] é›†æˆXXL-Jobåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦
- [ ] é›†æˆElasticsearchæœç´¢å¼•æ“
- [ ] é…ç½®ShardingSphereåˆ†åº“åˆ†è¡¨ç­–ç•¥
- [ ] ç¼–å†™æŠ€æœ¯é€‰å‹æ–‡æ¡£

**äº¤ä»˜ç‰©:**
- å¯è¿è¡Œçš„å¾®æœåŠ¡éª¨æ¶
- Seataã€XXL-Jobã€ESé›†æˆDemo
- æŠ€æœ¯é€‰å‹è¯„å®¡PPT

### Phase 2: æ ¸å¿ƒæœåŠ¡å¼€å‘ï¼ˆ3-4å‘¨ï¼‰

**ç›®æ ‡:** å®Œæˆæ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›

**Week 1-2: å•†å“ + åº“å­˜æœåŠ¡**
- [ ] å•†å“æœåŠ¡ï¼ˆSPU/SKUç®¡ç†ï¼‰
- [ ] åº“å­˜æœåŠ¡ï¼ˆRedisæ‰£å‡ + é¢„å æœºåˆ¶ï¼‰
- [ ] Elasticsearchå•†å“æœç´¢
- [ ] Canalæ•°æ®åŒæ­¥åˆ°ES

**Week 3-4: è®¢å•æœåŠ¡**
- [ ] è®¢å•æœåŠ¡ï¼ˆSpring StateMachineçŠ¶æ€æœºï¼‰
- [ ] Seataåˆ†å¸ƒå¼äº‹åŠ¡éªŒè¯ï¼ˆè®¢å•-åº“å­˜-æ”¯ä»˜ï¼‰
- [ ] è®¢å•è¶…æ—¶å–æ¶ˆï¼ˆXXL-Jobï¼‰
- [ ] è®¢å•æœç´¢ï¼ˆESï¼‰

**äº¤ä»˜ç‰©:**
- æ ¸å¿ƒæœåŠ¡APIæ–‡æ¡£ï¼ˆSwaggerï¼‰
- å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡>80%ï¼‰
- å‹æµ‹æŠ¥å‘Šï¼ˆJMeterï¼‰

### Phase 3: ä»“å‚¨ç‰©æµæœåŠ¡ï¼ˆ2-3å‘¨ï¼‰

**ç›®æ ‡:** å®Œæˆä»“å‚¨ç‰©æµèƒ½åŠ›

- [ ] ä»“å‚¨æœåŠ¡ï¼ˆå…¥åº“ã€å‡ºåº“ã€ç›˜ç‚¹ï¼‰
- [ ] ç‰©æµæœåŠ¡ï¼ˆTMSè¿è¾“ç®¡ç†ã€è·¯å¾„è§„åˆ’ï¼‰
- [ ] é…é€æœåŠ¡ï¼ˆéª‘æ‰‹è°ƒåº¦ã€è½¨è¿¹è¿½è¸ªï¼‰
- [ ] ç”µå­é¢å•å¯¹æ¥ï¼ˆèœé¸Ÿã€é¡ºä¸°ï¼‰

**äº¤ä»˜ç‰©:**
- WMS/TMSåŠŸèƒ½æ¼”ç¤º
- è·¯å¾„è§„åˆ’ç®—æ³•æ–‡æ¡£

### Phase 4: é‡‡è´­ç»“ç®—æœåŠ¡ï¼ˆ1-2å‘¨ï¼‰

**ç›®æ ‡:** å®Œæˆä¾›åº”é“¾é—­ç¯

- [ ] é‡‡è´­æœåŠ¡ï¼ˆé‡‡è´­å•ã€ä¾›åº”å•†ç®¡ç†ï¼‰
- [ ] ä¾›åº”å•†ååŒï¼ˆEDIå¯¹æ¥ã€APIå¼€æ”¾ï¼‰
- [ ] ç»“ç®—æœåŠ¡ï¼ˆå¯¹è´¦ã€å¼€ç¥¨ï¼‰
- [ ] è´¢åŠ¡æŠ¥è¡¨

**äº¤ä»˜ç‰©:**
- ä¾›åº”å•†é—¨æˆ·
- å¯¹è´¦æŠ¥è¡¨

### Phase 5: æ•°æ®å¹³å°ï¼ˆ2å‘¨ï¼‰

**ç›®æ ‡:** æ•°æ®é©±åŠ¨å†³ç­–

- [ ] å®æ—¶æ•°æ®åŒæ­¥ï¼ˆCanal -> Kafka -> Flinkï¼‰
- [ ] æ•°æ®ä»“åº“ï¼ˆHive/Icebergï¼‰
- [ ] BIæŠ¥è¡¨ä¸­å¿ƒï¼ˆå¤§å±å±•ç¤ºï¼‰
- [ ] æ™ºèƒ½è¡¥è´§ç®—æ³•ï¼ˆé”€é‡é¢„æµ‹ï¼‰

**äº¤ä»˜ç‰©:**
- æ•°æ®å¤§å±
- è¡¥è´§ç®—æ³•æ¨¡å‹

### Phase 6: æ€§èƒ½ä¼˜åŒ– & ä¸Šçº¿ï¼ˆ1-2å‘¨ï¼‰

**ç›®æ ‡:** ç”Ÿäº§å°±ç»ª

- [ ] JMeterå‹æµ‹ï¼ˆè®¢å•ï¼š1000 TPSï¼Œåº“å­˜ï¼š10000 TPSï¼‰
- [ ] æ€§èƒ½è°ƒä¼˜ï¼ˆç¼“å­˜ã€é™æµã€é™çº§ï¼‰
- [ ] å®¹é‡è¯„ä¼°ï¼ˆæœåŠ¡å™¨ã€æ•°æ®åº“ã€Redisï¼‰
- [ ] ç°åº¦å‘å¸ƒéªŒè¯
- [ ] ç›‘æ§å‘Šè­¦å®Œå–„

**äº¤ä»˜ç‰©:**
- å‹æµ‹æŠ¥å‘Š
- å®¹é‡è§„åˆ’æ–‡æ¡£
- ä¸Šçº¿æ£€æŸ¥æ¸…å•

---

## ä¹ã€å·®å¼‚åŒ–äº®ç‚¹ï¼ˆå¯¹æ ‡å¤§å‚ï¼‰

### 9.1 æŠ€æœ¯äº®ç‚¹

1. **åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§** â­â­â­â­â­
   - Seata ATæ¨¡å¼ + æœ¬åœ°æ¶ˆæ¯è¡¨å…œåº•
   - è®¢å•-åº“å­˜-æ”¯ä»˜ä¸‰æ®µå¼äº‹åŠ¡ä¿è¯

2. **é«˜å¹¶å‘åº“å­˜æ‰£å‡** â­â­â­â­â­
   - Redis Luaè„šæœ¬åŸå­æ“ä½œï¼ˆ10000 TPSï¼‰
   - é¢„å æœºåˆ¶ + å®šæ—¶é‡Šæ”¾
   - åº“å­˜å¿«ç…§ï¼ˆMVCCï¼‰

3. **è®¢å•çŠ¶æ€æœº** â­â­â­â­
   - Spring StateMachine + äº‹ä»¶æº¯æº
   - çŠ¶æ€æµè½¬å¯è§†åŒ–

4. **æ™ºèƒ½è·¯ç”±ç®—æ³•** â­â­â­â­
   - åŸºäºè·ç¦»ã€æˆæœ¬ã€æ—¶æ•ˆçš„å¤šç›®æ ‡ä¼˜åŒ–
   - TSPé—®é¢˜æ±‚è§£ï¼ˆé—ä¼ ç®—æ³•ï¼‰

5. **å®æ—¶æ•°æ®åŒæ­¥** â­â­â­â­
   - Canal binlogè§£æ -> Kafka -> Flink
   - æ¯«ç§’çº§æ•°æ®åŒæ­¥åˆ°ES

### 9.2 ä¸šåŠ¡äº®ç‚¹

1. **å¤šä»“ååŒ** - è·¨ä»“åº“æ™ºèƒ½è°ƒæ‹¨
2. **ä¾›åº”å•†ååŒ** - å¼€æ”¾API + EDIå¯¹æ¥
3. **æ™ºèƒ½è¡¥è´§** - åŸºäºLSTMé”€é‡é¢„æµ‹
4. **å…¨é“¾è·¯è¿½è¸ª** - ä»ä¸‹å•åˆ°æ”¶è´§å¯è§†åŒ–
5. **å¼‚å¸¸æ£€æµ‹** - AIè¯†åˆ«å¼‚å¸¸è®¢å•

---

## åã€æ€»ç»“

### å½“å‰ç³»ç»Ÿçš„ä¼˜åŠ¿

âœ… **åŸºç¡€è®¾æ–½å®Œå–„**: å¾®æœåŠ¡ã€ç½‘å…³ã€é…ç½®ä¸­å¿ƒã€æœåŠ¡æ²»ç†å…¨å¥—é½å…¨
âœ… **æ•°æ®è®¿é—®æˆç†Ÿ**: è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨ã€ä¸¤çº§ç¼“å­˜å·²å®ç°
âœ… **å®‰å…¨ä½“ç³»å¥å…¨**: JWTã€RBACã€æ•°æ®æƒé™ã€å®¡è®¡æ—¥å¿—å®Œæ•´
âœ… **å¯è§‚æµ‹æ€§å¼º**: SkyWalkingã€Prometheusã€Actuatoré…å¥—

### éœ€è¦è¡¥å……çš„å…³é”®èƒ½åŠ›

âš ï¸ **åˆ†å¸ƒå¼äº‹åŠ¡**: Seataæ˜¯å¿…é¡»é›†æˆçš„ï¼ˆ5æ˜Ÿé‡è¦ï¼‰
âš ï¸ **åº“å­˜ç³»ç»Ÿ**: Redis Lua + é¢„å æ˜¯æ ¸å¿ƒç«äº‰åŠ›
âš ï¸ **æœç´¢å¼•æ“**: Elasticsearchå¿…é¡»æœ‰
âš ï¸ **ä»»åŠ¡è°ƒåº¦**: XXL-Jobæ›¿ä»£Spring @Scheduled
âš ï¸ **æ•°æ®åŒæ­¥**: Canalå®ç°MySQL -> ESåŒæ­¥

### å®æ–½å»ºè®®

1. **å…ˆå¤åˆ¶åæ”¹é€ **: å¤ç”¨CommonPermissionsFramework 90%ä»£ç 
2. **æ¸è¿›å¼å¢å¼º**: æŒ‰Phase 1-6é€æ­¥å®Œå–„ï¼Œä¸æ±‚ä¸€æ­¥åˆ°ä½
3. **çªå‡ºæ ¸å¿ƒ**: é‡ç‚¹åšå¥½åº“å­˜æ‰£å‡å’Œåˆ†å¸ƒå¼äº‹åŠ¡
4. **å‚è€ƒå¤§å‚**: å¤šç ”ç©¶é˜¿é‡Œã€äº¬ä¸œçš„å¼€æºé¡¹ç›®
5. **æŒç»­ä¼˜åŒ–**: ä¸Šçº¿åæ ¹æ®å‹æµ‹ç»“æœæŒç»­è°ƒä¼˜

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2024-12-24
**ä½œè€…**: Claude Code AI Assistant