# XXL-Job åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦é›†æˆæŒ‡å—

æœ¬æ–‡æ¡£æä¾› SCM Platform ä¸­ XXL-Job åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦çš„å®Œæ•´é›†æˆã€é…ç½®å’Œä½¿ç”¨æŒ‡å—ã€‚

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [è¯¦ç»†é…ç½®](#è¯¦ç»†é…ç½®)
4. [ä»»åŠ¡å¼€å‘](#ä»»åŠ¡å¼€å‘)
5. [ä»»åŠ¡ç®¡ç†](#ä»»åŠ¡ç®¡ç†)
6. [ç›‘æ§å‘Šè­¦](#ç›‘æ§å‘Šè­¦)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¶æ„æ¦‚è¿°

### XXL-Job æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    XXL-Job æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  XXL-Job Admin   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   MySQL 8.0      â”‚          â”‚
â”‚  â”‚  (è°ƒåº¦ä¸­å¿ƒ)       â”‚         â”‚   (ä»»åŠ¡å…ƒæ•°æ®)    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                                                  â”‚
â”‚           â”‚ HTTP è°ƒåº¦                                        â”‚
â”‚           â”‚                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚             â”‚                â”‚                â”‚        â”‚
â”‚    â–¼             â–¼                â–¼                â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”       â”‚
â”‚  â”‚è®¢å•â”‚       â”‚åº“å­˜â”‚          â”‚ä»“å‚¨â”‚          â”‚ç‰©æµâ”‚       â”‚
â”‚  â”‚æœåŠ¡â”‚       â”‚æœåŠ¡â”‚          â”‚æœåŠ¡â”‚          â”‚æœåŠ¡â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”˜       â”‚
â”‚   9999         9998            9997            9996         â”‚
â”‚  (Executor)   (Executor)     (Executor)     (Executor)     â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶è¯´æ˜

- **XXL-Job Admin**: è°ƒåº¦ä¸­å¿ƒï¼Œç®¡ç†ä»»åŠ¡é…ç½®ã€è°ƒåº¦ç­–ç•¥ã€æ‰§è¡Œæ—¥å¿—
- **XXL-Job Executor**: æ‰§è¡Œå™¨ï¼ŒåµŒå…¥å¾®æœåŠ¡ï¼Œæ¥æ”¶è°ƒåº¦æŒ‡ä»¤æ‰§è¡Œä»»åŠ¡
- **MySQL**: å­˜å‚¨ä»»åŠ¡å…ƒæ•°æ®ã€æ‰§è¡Œæ—¥å¿—ã€è°ƒåº¦é”

### ä»»åŠ¡ç±»å‹

1. **BEAN æ¨¡å¼**: Java ç±»ä»»åŠ¡ï¼ˆæ¨èï¼‰
2. **GLUE æ¨¡å¼**: åœ¨çº¿ç¼–è¾‘è„šæœ¬ä»»åŠ¡ï¼ˆJava/Shell/Python/PHP/NodeJSï¼‰

---

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ XXL-Job Admin

```bash
# é€šè¿‡ Docker Compose å¯åŠ¨
docker-compose up -d xxl-job-admin mysql-xxljob

# éªŒè¯å¯åŠ¨
docker logs -f scm-xxl-job

# é¢„æœŸæ—¥å¿—:
# xxl-job remoting server start success, nettype = class com.xxl.job.core.server.EmbedServer, port = 8080
```

### 2. è®¿é—® XXL-Job æ§åˆ¶å°

```
URL: http://localhost:8088/xxl-job-admin
ç”¨æˆ·å: admin
å¯†ç : 123456
```

### 3. éªŒè¯æ‰§è¡Œå™¨æ³¨å†Œ

å¯åŠ¨å¾®æœåŠ¡åï¼Œåœ¨æ§åˆ¶å°æŸ¥çœ‹æ‰§è¡Œå™¨:

```
æ‰§è¡Œå™¨ç®¡ç† â†’ åœ¨çº¿æ‰§è¡Œå™¨åˆ—è¡¨
åº”è¯¥çœ‹åˆ°:
- scm-order-executor (è®¢å•æœåŠ¡)
- scm-inventory-executor (åº“å­˜æœåŠ¡)
```

### 4. å¯åŠ¨ä»»åŠ¡

```
ä»»åŠ¡ç®¡ç† â†’ é€‰æ‹©æ‰§è¡Œå™¨ â†’ æ“ä½œåˆ— â†’ å¯åŠ¨
```

---

## è¯¦ç»†é…ç½®

### XXL-Job Admin é…ç½®

**Docker Compose é…ç½®** (`docker-compose.yml`):

```yaml
xxl-job-admin:
  image: xuxueli/xxl-job-admin:2.4.3
  container_name: scm-xxl-job
  ports:
    - "8088:8080"
  environment:
    PARAMS: >
      --spring.datasource.url=jdbc:mysql://mysql-xxljob:3306/xxl_job
      --spring.datasource.username=root
      --spring.datasource.password=root
  volumes:
    - xxljob_data:/data/applogs
  depends_on:
    - mysql-xxljob
```

### æ‰§è¡Œå™¨é…ç½® (application.yml)

**è®¢å•æœåŠ¡** (`scm-order/service/src/main/resources/application.yml`):

```yaml
xxl:
  job:
    admin:
      addresses: http://localhost:8088/xxl-job-admin  # Admin åœ°å€
    executor:
      appname: scm-order-executor                      # æ‰§è¡Œå™¨åç§°ï¼ˆå¿…é¡»ä¸ Admin ä¸­é…ç½®ä¸€è‡´ï¼‰
      address:                                         # æ‰§è¡Œå™¨åœ°å€ï¼ˆç•™ç©ºè‡ªåŠ¨è·å–ï¼‰
      ip:                                              # æ‰§è¡Œå™¨ IPï¼ˆç•™ç©ºè‡ªåŠ¨è·å–ï¼‰
      port: 9999                                       # æ‰§è¡Œå™¨ç«¯å£
      logpath: /data/applogs/xxl-job/jobhandler       # æ—¥å¿—è·¯å¾„
      logretentiondays: 30                             # æ—¥å¿—ä¿ç•™å¤©æ•°
    accessToken: default_token                         # è®¿é—®ä»¤ç‰Œï¼ˆéœ€ä¸ Admin ä¸€è‡´ï¼‰
```

**åº“å­˜æœåŠ¡** (`scm-inventory/service/src/main/resources/application.yml`):

```yaml
xxl:
  job:
    admin:
      addresses: http://localhost:8088/xxl-job-admin
    executor:
      appname: scm-inventory-executor                  # ä¸åŒçš„æ‰§è¡Œå™¨åç§°
      port: 9998                                       # ä¸åŒçš„ç«¯å£
      logpath: /data/applogs/xxl-job/jobhandler
      logretentiondays: 30
    accessToken: default_token
```

### Java é…ç½®ç±»

**XxlJobConfig.java**:

```java
@Slf4j
@Configuration
public class XxlJobConfig {

    @Value("${xxl.job.admin.addresses}")
    private String adminAddresses;

    @Value("${xxl.job.executor.appname}")
    private String appname;

    @Value("${xxl.job.executor.port}")
    private int port;

    @Bean
    public XxlJobSpringExecutor xxlJobExecutor() {
        log.info("ğŸš€ [XXL-Job] åˆå§‹åŒ–æ‰§è¡Œå™¨: appname={}", appname);

        XxlJobSpringExecutor executor = new XxlJobSpringExecutor();
        executor.setAdminAddresses(adminAddresses);
        executor.setAppname(appname);
        executor.setPort(port);
        // ... å…¶ä»–é…ç½®

        return executor;
    }
}
```

---

## ä»»åŠ¡å¼€å‘

### ç¤ºä¾‹ 1: è®¢å•è¶…æ—¶å–æ¶ˆä»»åŠ¡

**ä¸šåŠ¡åœºæ™¯**: æ¯åˆ†é’Ÿæ‰«æè¶…æ—¶æœªæ”¯ä»˜è®¢å•ï¼Œè‡ªåŠ¨å–æ¶ˆå¹¶é‡Šæ”¾åº“å­˜

**å®ç°ä»£ç **:

```java
@Slf4j
@Component
public class OrderTimeoutCancelJobHandler {

    @Autowired
    private OrderMapper orderMapper;

    @DubboReference
    private InventoryDubboService inventoryService;

    /**
     * è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆä»»åŠ¡
     *
     * @XxlJob: ä»»åŠ¡æ ‡è¯†ï¼Œå¿…é¡»ä¸ Admin ä¸­é…ç½®çš„ JobHandler ä¸€è‡´
     */
    @XxlJob("orderTimeoutCancelJobHandler")
    public void execute() throws Exception {
        XxlJobHelper.log("â° [è®¢å•è¶…æ—¶å–æ¶ˆ] å¼€å§‹æ‰§è¡Œä»»åŠ¡");

        // 1. è·å–ä»»åŠ¡å‚æ•°ï¼ˆè¶…æ—¶åˆ†é’Ÿæ•°ï¼‰
        String param = XxlJobHelper.getJobParam();
        int timeoutMinutes = Integer.parseInt(param != null && !param.isEmpty() ? param : "30");

        // 2. æŸ¥è¯¢è¶…æ—¶è®¢å•
        LocalDateTime threshold = LocalDateTime.now().minusMinutes(timeoutMinutes);
        List<Order> timeoutOrders = orderMapper.selectList(
            new LambdaQueryWrapper<Order>()
                .eq(Order::getStatus, "PENDING_PAYMENT")
                .lt(Order::getCreateTime, threshold)
                .last("LIMIT 1000")
        );

        XxlJobHelper.log("ğŸ“‹ å‘ç°è¶…æ—¶è®¢å•: count={}", timeoutOrders.size());

        // 3. æ‰¹é‡å–æ¶ˆè®¢å•
        int successCount = 0;
        for (Order order : timeoutOrders) {
            try {
                cancelOrder(order);  // åˆ†å¸ƒå¼äº‹åŠ¡å–æ¶ˆè®¢å•
                successCount++;
                XxlJobHelper.log("  âœ“ å–æ¶ˆæˆåŠŸ: orderNo={}", order.getOrderNo());
            } catch (Exception e) {
                XxlJobHelper.log("  âœ— å–æ¶ˆå¤±è´¥: orderNo={}", order.getOrderNo());
            }
        }

        // 4. è¿”å›ä»»åŠ¡ç»“æœ
        XxlJobHelper.handleSuccess(String.format("æˆåŠŸå–æ¶ˆ %d ä¸ªè®¢å•", successCount));
    }

    @GlobalTransactional(rollbackFor = Exception.class)
    public void cancelOrder(Order order) {
        // æ›´æ–°è®¢å•çŠ¶æ€
        orderMapper.updateById(order.setStatus("CANCELLED_TIMEOUT"));

        // é‡Šæ”¾åº“å­˜ï¼ˆRPC è°ƒç”¨ï¼Œå‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰
        inventoryService.releaseStock(order.getSkuId(), order.getQuantity(), "TIMEOUT:" + order.getOrderNo());
    }
}
```

### ç¤ºä¾‹ 2: åº“å­˜å¿«ç…§åŒæ­¥ä»»åŠ¡

**ä¸šåŠ¡åœºæ™¯**: æ¯å¤©å‡Œæ™¨ 1 ç‚¹ç”Ÿæˆåº“å­˜å¿«ç…§ï¼Œç”¨äºæ•°æ®åˆ†æ

**å®ç°ä»£ç **:

```java
@Slf4j
@Component
public class InventorySnapshotJobHandler {

    @Autowired
    private InventoryMapper inventoryMapper;

    @Autowired
    private SnapshotMapper snapshotMapper;

    @XxlJob("inventorySnapshotJobHandler")
    @Transactional(rollbackFor = Exception.class)
    public void execute() throws Exception {
        XxlJobHelper.log("ğŸ“¸ [åº“å­˜å¿«ç…§] å¼€å§‹æ‰§è¡Œä»»åŠ¡");

        // 1. æŸ¥è¯¢æ‰€æœ‰åº“å­˜
        List<Inventory> inventories = inventoryMapper.selectList(null);
        XxlJobHelper.log("ğŸ“‹ åº“å­˜è®°å½•æ•°: {}", inventories.size());

        // 2. ç”Ÿæˆå¿«ç…§
        int successCount = 0;
        LocalDateTime snapshotTime = LocalDateTime.now();

        for (Inventory inv : inventories) {
            Snapshot snapshot = new Snapshot();
            snapshot.setSkuId(inv.getSkuId());
            snapshot.setAvailableStock(inv.getAvailableStock());
            snapshot.setLockedStock(inv.getLockedStock());
            snapshot.setSnapshotTime(snapshotTime);

            snapshotMapper.insert(snapshot);
            successCount++;

            if (successCount % 100 == 0) {
                XxlJobHelper.log("  å·²ç”Ÿæˆå¿«ç…§: {}/{}", successCount, inventories.size());
            }
        }

        XxlJobHelper.handleSuccess(String.format("ç”Ÿæˆå¿«ç…§: %d æ¡", successCount));
    }
}
```

### ä»»åŠ¡å¼€å‘è§„èŒƒ

#### âœ… å¿…é¡»éµå®ˆ

1. **ä½¿ç”¨ @XxlJob æ³¨è§£**: æ–¹æ³•å¿…é¡»ä½¿ç”¨ `@XxlJob("handlerName")` æ³¨è§£
2. **ä½¿ç”¨ XxlJobHelper è®°å½•æ—¥å¿—**: æ—¥å¿—ä¼šæ˜¾ç¤ºåœ¨ Admin æ§åˆ¶å°
3. **è¿”å›ä»»åŠ¡ç»“æœ**: ä½¿ç”¨ `XxlJobHelper.handleSuccess()` æˆ– `handleFail()`
4. **å¼‚å¸¸å¤„ç†**: æ•è·å¼‚å¸¸å¹¶è®°å½•è¯¦ç»†ä¿¡æ¯
5. **å‚æ•°è·å–**: ä½¿ç”¨ `XxlJobHelper.getJobParam()` è·å–ä»»åŠ¡å‚æ•°
6. **å¹‚ç­‰æ€§è®¾è®¡**: ä»»åŠ¡å¿…é¡»æ”¯æŒé‡å¤æ‰§è¡Œ

#### âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¿å…é•¿æ—¶é—´è¿è¡Œ**: ä»»åŠ¡è¶…æ—¶é»˜è®¤ 5 åˆ†é’Ÿï¼Œå¯é…ç½®
2. **æ‰¹é‡å¤„ç†ä½¿ç”¨åˆ†é¡µ**: é¿å…ä¸€æ¬¡æ€§æŸ¥è¯¢å¤§é‡æ•°æ®
3. **è®°å½•å¤„ç†è¿›åº¦**: ä½¿ç”¨ `XxlJobHelper.log()` è®°å½•å…³é”®èŠ‚ç‚¹
4. **ä½¿ç”¨åˆ†ç‰‡æ‰§è¡Œ**: å¤§æ•°æ®é‡ä»»åŠ¡ä½¿ç”¨åˆ†ç‰‡å‚æ•°

---

## ä»»åŠ¡ç®¡ç†

### åœ¨ Admin æ§åˆ¶å°é…ç½®ä»»åŠ¡

**1. æ·»åŠ æ‰§è¡Œå™¨** (`æ‰§è¡Œå™¨ç®¡ç†` â†’ `æ–°å¢`):

```
AppName: scm-order-executor
åç§°: è®¢å•æœåŠ¡æ‰§è¡Œå™¨
æ³¨å†Œæ–¹å¼: è‡ªåŠ¨æ³¨å†Œ
```

**2. æ·»åŠ ä»»åŠ¡** (`ä»»åŠ¡ç®¡ç†` â†’ `æ–°å¢`):

```
æ‰§è¡Œå™¨: scm-order-executor
ä»»åŠ¡æè¿°: è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
è·¯ç”±ç­–ç•¥: FIRST (ç¬¬ä¸€ä¸ª)
Cron: 0 */1 * * * ?  (æ¯åˆ†é’Ÿæ‰§è¡Œ)
è¿è¡Œæ¨¡å¼: BEAN
JobHandler: orderTimeoutCancelJobHandler
ä»»åŠ¡å‚æ•°: 30  (30 åˆ†é’Ÿè¶…æ—¶)
é˜»å¡å¤„ç†ç­–ç•¥: å•æœºä¸²è¡Œ
å­ä»»åŠ¡: (ç•™ç©º)
ä»»åŠ¡è¶…æ—¶æ—¶é—´: 300 ç§’
å¤±è´¥é‡è¯•æ¬¡æ•°: 3
```

**3. å¯åŠ¨ä»»åŠ¡**:

ç‚¹å‡»ä»»åŠ¡åˆ—è¡¨ä¸­çš„ "å¯åŠ¨" æŒ‰é’®

### è°ƒåº¦ç­–ç•¥è¯´æ˜

| Cron è¡¨è¾¾å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------------|------|------|
| `0 */1 * * * ?` | æ¯åˆ†é’Ÿæ‰§è¡Œ | è®¢å•è¶…æ—¶å–æ¶ˆ |
| `0 0 1 * * ?` | æ¯å¤©å‡Œæ™¨ 1 ç‚¹ | åº“å­˜å¿«ç…§ |
| `0 0 */2 * * ?` | æ¯ 2 å°æ—¶æ‰§è¡Œ | æ•°æ®åŒæ­¥ |
| `0 0 0 * * ?` | æ¯å¤©é›¶ç‚¹æ‰§è¡Œ | æ—¥æŠ¥ç»Ÿè®¡ |
| `0 0 12 * * ?` | æ¯å¤©ä¸­åˆ 12 ç‚¹ | åˆé—´æ•°æ®æ±‡æ€» |

**Cron åœ¨çº¿ç”Ÿæˆå™¨**: https://cron.qqe2.com/

### è·¯ç”±ç­–ç•¥

| ç­–ç•¥ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|---------|
| FIRST | ç¬¬ä¸€ä¸ªæ‰§è¡Œå™¨ | å•æœºä»»åŠ¡ |
| LAST | æœ€åä¸€ä¸ªæ‰§è¡Œå™¨ | - |
| ROUND | è½®è¯¢ | è´Ÿè½½å‡è¡¡ |
| RANDOM | éšæœº | è´Ÿè½½å‡è¡¡ |
| CONSISTENT_HASH | ä¸€è‡´æ€§å“ˆå¸Œ | æŒ‰å‚æ•°è·¯ç”± |
| SHARDING_BROADCAST | åˆ†ç‰‡å¹¿æ’­ | å¤§æ•°æ®é‡å¤„ç† |

### é˜»å¡å¤„ç†ç­–ç•¥

| ç­–ç•¥ | è¯´æ˜ |
|------|------|
| å•æœºä¸²è¡Œ | åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªä»»åŠ¡å®ä¾‹è¿è¡Œ |
| ä¸¢å¼ƒåç»­è°ƒåº¦ | æ–°ä»»åŠ¡è¢«è§¦å‘æ—¶ï¼Œå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡è¿˜åœ¨è¿è¡Œï¼Œåˆ™ä¸¢å¼ƒæ–°ä»»åŠ¡ |
| è¦†ç›–ä¹‹å‰è°ƒåº¦ | æ–°ä»»åŠ¡è¢«è§¦å‘æ—¶ï¼Œå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡è¿˜åœ¨è¿è¡Œï¼Œåˆ™ç»ˆæ­¢ä¸Šä¸€ä¸ªä»»åŠ¡ |

---

## ç›‘æ§å‘Šè­¦

### æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæ—¥å¿—

```
ä»»åŠ¡ç®¡ç† â†’ æ“ä½œ â†’ æ‰§è¡Œæ—¥å¿—
```

æ—¥å¿—åŒ…å«:
- è°ƒåº¦æ—¶é—´
- è°ƒåº¦ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- æ‰§è¡Œæ—¶é—´
- æ‰§è¡Œæ—¥å¿—ï¼ˆXxlJobHelper.log() è¾“å‡ºçš„å†…å®¹ï¼‰
- æ‰§è¡Œç»“æœï¼ˆhandleSuccess/handleFail çš„æ¶ˆæ¯ï¼‰

### å‘Šè­¦é…ç½®

**1. é‚®ä»¶å‘Šè­¦** (`ä»»åŠ¡ç®¡ç†` â†’ `ç¼–è¾‘ä»»åŠ¡`):

```
æŠ¥è­¦é‚®ä»¶: admin@example.com,team@example.com
```

ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶ï¼Œä¼šè‡ªåŠ¨å‘é€é‚®ä»¶é€šçŸ¥ã€‚

**2. é’‰é’‰å‘Šè­¦** (é€šè¿‡ WebHook):

åœ¨ä»»åŠ¡ä»£ç ä¸­æ·»åŠ é’‰é’‰é€šçŸ¥:

```java
@XxlJob("criticalJobHandler")
public void execute() {
    try {
        // ä¸šåŠ¡é€»è¾‘
    } catch (Exception e) {
        XxlJobHelper.log("ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {}", e.getMessage());
        sendDingTalkAlert("è®¢å•è¶…æ—¶å–æ¶ˆä»»åŠ¡å¤±è´¥", e.getMessage());
        throw e;
    }
}

private void sendDingTalkAlert(String title, String content) {
    // è°ƒç”¨é’‰é’‰ WebHook API
}
```

### ç›‘æ§æŒ‡æ ‡

**1. ä»»åŠ¡æ‰§è¡ŒæŠ¥è¡¨** (`è°ƒåº¦æŠ¥è¡¨`):
- æ¯æ—¥æ‰§è¡Œæ€»æ•°
- æˆåŠŸç‡
- å¹³å‡æ‰§è¡Œæ—¶é—´

**2. æ‰§è¡Œå™¨å¥åº·æ£€æŸ¥**:
- åœ¨çº¿æ‰§è¡Œå™¨æ•°é‡
- æ³¨å†Œæ—¶é—´
- å¿ƒè·³æ—¶é—´

---

## æœ€ä½³å®è·µ

### 1. ä»»åŠ¡å¹‚ç­‰æ€§è®¾è®¡

```java
@XxlJob("orderSyncJobHandler")
public void execute() {
    String jobId = XxlJobHelper.getJobId() + "_" + System.currentTimeMillis();

    // ä½¿ç”¨ Redis é˜²æ­¢é‡å¤æ‰§è¡Œ
    Boolean locked = redisTemplate.opsForValue()
        .setIfAbsent("job:lock:" + jobId, "1", 10, TimeUnit.MINUTES);

    if (Boolean.FALSE.equals(locked)) {
        XxlJobHelper.log("ä»»åŠ¡å·²åœ¨æ‰§è¡Œä¸­ï¼Œè·³è¿‡");
        return;
    }

    try {
        // ä¸šåŠ¡é€»è¾‘
    } finally {
        redisTemplate.delete("job:lock:" + jobId);
    }
}
```

### 2. åˆ†ç‰‡æ‰§è¡Œå¤§ä»»åŠ¡

```java
@XxlJob("largeDataJobHandler")
public void execute() {
    // è·å–åˆ†ç‰‡å‚æ•°
    int shardIndex = XxlJobHelper.getShardIndex();  // å½“å‰åˆ†ç‰‡ç´¢å¼• (0-based)
    int shardTotal = XxlJobHelper.getShardTotal();  // æ€»åˆ†ç‰‡æ•°

    XxlJobHelper.log("åˆ†ç‰‡æ‰§è¡Œ: {}/{}", shardIndex + 1, shardTotal);

    // æ ¹æ®åˆ†ç‰‡å‚æ•°æŸ¥è¯¢æ•°æ®
    List<Order> orders = orderMapper.selectList(
        new LambdaQueryWrapper<Order>()
            .apply("MOD(id, {0}) = {1}", shardTotal, shardIndex)
            .last("LIMIT 10000")
    );

    // å¤„ç†æ•°æ®
    for (Order order : orders) {
        // å¤„ç†é€»è¾‘
    }

    XxlJobHelper.handleSuccess(String.format("åˆ†ç‰‡ %d/%d å®Œæˆï¼Œå¤„ç† %d æ¡",
        shardIndex + 1, shardTotal, orders.size()));
}
```

### 3. ä»»åŠ¡å‚æ•°åŒ–

```java
@XxlJob("configJobHandler")
public void execute() {
    // ä»ä»»åŠ¡å‚æ•°ä¸­è¯»å–é…ç½®
    String param = XxlJobHelper.getJobParam();
    JSONObject config = JSON.parseObject(param);

    int batchSize = config.getIntValue("batchSize");
    int timeoutMinutes = config.getIntValue("timeoutMinutes");
    String targetStatus = config.getString("targetStatus");

    // ä½¿ç”¨å‚æ•°æ‰§è¡Œä¸šåŠ¡é€»è¾‘
}
```

**Admin ä¸­é…ç½®ä»»åŠ¡å‚æ•°**:

```json
{
  "batchSize": 1000,
  "timeoutMinutes": 30,
  "targetStatus": "CANCELLED"
}
```

### 4. å¼‚å¸¸å¤„ç†ä¸é‡è¯•

```java
@XxlJob("retryJobHandler")
public void execute() {
    int maxRetries = 3;
    int retryCount = 0;
    Exception lastException = null;

    while (retryCount < maxRetries) {
        try {
            // ä¸šåŠ¡é€»è¾‘
            performTask();
            XxlJobHelper.handleSuccess("æ‰§è¡ŒæˆåŠŸ");
            return;
        } catch (Exception e) {
            retryCount++;
            lastException = e;
            XxlJobHelper.log("æ‰§è¡Œå¤±è´¥ï¼Œé‡è¯• {}/{}: {}",
                retryCount, maxRetries, e.getMessage());

            if (retryCount < maxRetries) {
                Thread.sleep(5000);  // ç­‰å¾… 5 ç§’åé‡è¯•
            }
        }
    }

    XxlJobHelper.handleFail("é‡è¯• " + maxRetries + " æ¬¡åä»å¤±è´¥: " + lastException.getMessage());
}
```

### 5. ä»»åŠ¡æ‰§è¡Œæ—¥å¿—è§„èŒƒ

```java
@XxlJob("standardJobHandler")
public void execute() {
    long startTime = System.currentTimeMillis();

    // 1. ä»»åŠ¡å¼€å§‹
    XxlJobHelper.log("ğŸš€ [ä»»åŠ¡åç§°] å¼€å§‹æ‰§è¡Œ");

    // 2. å‚æ•°è§£æ
    String param = XxlJobHelper.getJobParam();
    XxlJobHelper.log("ğŸ“ ä»»åŠ¡å‚æ•°: {}", param);

    // 3. å…³é”®æ­¥éª¤è®°å½•
    XxlJobHelper.log("ğŸ“Š æ­¥éª¤ 1: æŸ¥è¯¢æ•°æ®");
    // ... ä¸šåŠ¡é€»è¾‘

    XxlJobHelper.log("âœ… æ­¥éª¤ 1 å®Œæˆ: æŸ¥è¯¢åˆ° {} æ¡è®°å½•", count);

    // 4. æ‰§è¡Œç»“æœ
    long duration = System.currentTimeMillis() - startTime;
    XxlJobHelper.handleSuccess(String.format(
        "ä»»åŠ¡å®Œæˆ: å¤„ç†=%d, æˆåŠŸ=%d, å¤±è´¥=%d, è€—æ—¶=%dms",
        total, success, failed, duration
    ));
}
```

### 6. ä»»åŠ¡ä¾èµ–ï¼ˆå­ä»»åŠ¡ï¼‰

```java
// çˆ¶ä»»åŠ¡: æ•°æ®å¯¼å…¥
@XxlJob("dataImportJobHandler")
public void importData() {
    // å¯¼å…¥æ•°æ®
    XxlJobHelper.log("æ•°æ®å¯¼å…¥å®Œæˆ");
    // å­ä»»åŠ¡ä¼šè‡ªåŠ¨è§¦å‘
}

// å­ä»»åŠ¡: æ•°æ®æ ¡éªŒï¼ˆåœ¨ Admin ä¸­é…ç½®ä¸ºçˆ¶ä»»åŠ¡çš„å­ä»»åŠ¡ï¼‰
@XxlJob("dataValidationJobHandler")
public void validateData() {
    // æ ¡éªŒæ•°æ®
    XxlJobHelper.log("æ•°æ®æ ¡éªŒå®Œæˆ");
}
```

**Admin é…ç½®**:
- çˆ¶ä»»åŠ¡ `dataImportJobHandler` çš„å­ä»»åŠ¡ ID å¡«å†™å­ä»»åŠ¡çš„ ID
- çˆ¶ä»»åŠ¡æ‰§è¡ŒæˆåŠŸåï¼Œå­ä»»åŠ¡è‡ªåŠ¨è§¦å‘

---

## å¸¸è§é—®é¢˜

### 1. æ‰§è¡Œå™¨æœªæ³¨å†Œ

**é”™è¯¯**: æ§åˆ¶å°çœ‹ä¸åˆ°æ‰§è¡Œå™¨

**è§£å†³**:
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨
curl http://localhost:8203/actuator/health

# æ£€æŸ¥æ‰§è¡Œå™¨é…ç½®
cat scm-order/service/src/main/resources/application.yml | grep -A 10 "xxl.job"

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
# åº”è¯¥çœ‹åˆ°: [XXL-Job] æ‰§è¡Œå™¨åˆå§‹åŒ–å®Œæˆ
```

### 2. ä»»åŠ¡æ‰§è¡Œå¤±è´¥

**é”™è¯¯**: ä»»åŠ¡çŠ¶æ€æ˜¾ç¤ºå¤±è´¥

**è§£å†³**:
1. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥ JobHandler åç§°æ˜¯å¦ä¸ `@XxlJob` æ³¨è§£ä¸€è‡´
3. æ£€æŸ¥ä»»åŠ¡è¶…æ—¶æ—¶é—´æ˜¯å¦è¶³å¤Ÿ
4. æŸ¥çœ‹æœåŠ¡æ—¥å¿—ä¸­çš„è¯¦ç»†å †æ ˆ

### 3. ä»»åŠ¡é‡å¤æ‰§è¡Œ

**åŸå› **: æœªé…ç½®é˜»å¡å¤„ç†ç­–ç•¥

**è§£å†³**:
- ä»»åŠ¡é…ç½®ä¸­é€‰æ‹© "å•æœºä¸²è¡Œ"
- åœ¨ä»£ç ä¸­å®ç°å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆä½¿ç”¨åˆ†å¸ƒå¼é”ï¼‰

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

```sql
-- ä¸º xxl_job_log è¡¨æ·»åŠ ç´¢å¼•
CREATE INDEX idx_trigger_time ON xxl_job_log(trigger_time);
CREATE INDEX idx_job_id ON xxl_job_log(job_id);

-- å®šæœŸæ¸…ç†å†å²æ—¥å¿—ï¼ˆä¿ç•™ 30 å¤©ï¼‰
DELETE FROM xxl_job_log WHERE trigger_time < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### 2. ä»»åŠ¡åˆ†ç‰‡

- å•ä¸ªä»»åŠ¡å¤„ç†æ•°æ®é‡è¶…è¿‡ 10000 æ¡æ—¶ï¼Œä½¿ç”¨åˆ†ç‰‡æ‰§è¡Œ
- åˆ†ç‰‡æ•°å»ºè®®è®¾ç½®ä¸ºæ‰§è¡Œå™¨æ•°é‡çš„ 2-4 å€

### 3. å¼‚æ­¥æ‰§è¡Œ

```java
@XxlJob("asyncJobHandler")
public void execute() {
    // ä¸»ä»»åŠ¡å¿«é€Ÿè¿”å›
    CompletableFuture.runAsync(() -> {
        // å¼‚æ­¥æ‰§è¡Œè€—æ—¶æ“ä½œ
        performHeavyTask();
    });

    XxlJobHelper.handleSuccess("ä»»åŠ¡å·²æäº¤å¼‚æ­¥æ‰§è¡Œ");
}
```

---

## å‚è€ƒèµ„æ–™

- [XXL-Job å®˜æ–¹æ–‡æ¡£](https://www.xuxueli.com/xxl-job/)
- [XXL-Job GitHub](https://github.com/xuxueli/xxl-job)
- [SCM Platform CLAUDE.md](../CLAUDE.md)

---

**ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-12-26
**ç»´æŠ¤è€…**: SCM Platform Team