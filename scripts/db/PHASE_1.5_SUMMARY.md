# SCM Platform Database Design - Phase 1.5 Summary

## ğŸ“Š Overview

æœ¬æ–‡æ¡£æ±‡æ€»äº† SCM Platform æ•°æ®åº“è®¾è®¡çš„ **Phase 1** å’Œ **Phase 1.5** çš„å®Œæ•´æˆæœã€‚

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

- **å¤šç§Ÿæˆ·SaaSå¹³å°**ï¼šæ”¯æŒä¸­å¤§è§„æ¨¡ä¸šåŠ¡ï¼ˆæ—¥è®¢å• 5k-5wï¼‰
- **æ•°æ®éš”ç¦»**ï¼šåŸºäº tenant_id çš„å…±äº«è¡¨æ–¹æ¡ˆ
- **å¾®æœåŠ¡æ¶æ„**ï¼š12ä¸ªä¸šåŠ¡æ•°æ®åº“ + 1ä¸ªç§Ÿæˆ·ç®¡ç†æ•°æ®åº“
- **é«˜æ€§èƒ½**ï¼šåˆ†åŒºè¡¨ã€ç´¢å¼•ä¼˜åŒ–ã€æ‰¹æ¬¡ç®¡ç†
- **ä¸šåŠ¡å®Œæ•´æ€§**ï¼šæ¶µç›–å•†å“ã€åº“å­˜ã€è®¢å•ã€ä»“å‚¨ã€ç‰©æµã€ä¾›åº”å•†ã€è´¢åŠ¡å…¨æµç¨‹

---

## ğŸ“‚ Database Architecture

```
SCM Platform Databases (13ä¸ªæ•°æ®åº“)
â”œâ”€â”€ 001-009: åŸºç¡€æ”¯æ’‘æ•°æ®åº“ï¼ˆå·²æœ‰ï¼‰
â”‚   â”œâ”€â”€ db_user         (ç”¨æˆ·)
â”‚   â”œâ”€â”€ db_org          (ç»„ç»‡)
â”‚   â”œâ”€â”€ db_permission   (æƒé™)
â”‚   â””â”€â”€ ... (å…¶ä»–åŸºç¡€åº“)
â”‚
â”œâ”€â”€ 010-015: æ ¸å¿ƒä¸šåŠ¡æ•°æ®åº“ï¼ˆPhase 1ï¼‰
â”‚   â”œâ”€â”€ 010_db_product     (å•†å“æœåŠ¡ï¼Œ7å¼ è¡¨)
â”‚   â”œâ”€â”€ 011_db_inventory   (åº“å­˜æœåŠ¡ï¼Œ5å¼ è¡¨ + æ‰©å±•5å¼ )
â”‚   â”œâ”€â”€ 012_db_order       (è®¢å•æœåŠ¡ï¼Œ5å¼ è¡¨)
â”‚   â”œâ”€â”€ 013_db_warehouse   (ä»“å‚¨æœåŠ¡ï¼Œ7å¼ è¡¨)
â”‚   â”œâ”€â”€ 014_db_logistics   (ç‰©æµæœåŠ¡ï¼Œ5å¼ è¡¨)
â”‚   â””â”€â”€ 015_db_supplier    (ä¾›åº”å•†æœåŠ¡ï¼Œ5å¼ è¡¨ + æ‰©å±•5å¼ )
â”‚
â””â”€â”€ 016-017: å¹³å°æ”¯æ’‘æ•°æ®åº“ï¼ˆPhase 1.5ï¼‰
    â”œâ”€â”€ 016_db_tenant      (å¤šç§Ÿæˆ·ç®¡ç†ï¼Œ7å¼ è¡¨)
    â””â”€â”€ 017_db_finance     (è´¢åŠ¡ç»“ç®—ï¼Œ8å¼ è¡¨)
```

---

## ğŸ“‹ Phase 1 - æ ¸å¿ƒä¸šåŠ¡æ•°æ®åº“

### 1. **å•†å“æœåŠ¡** (010_db_product.sql)

| è¡¨å | è¯´æ˜ | å…³é”®ç‰¹æ€§ |
|-----|------|---------|
| prod_category | å•†å“åˆ†ç±» | 5çº§åˆ†ç±»æ ‘ã€è‡ªå¼•ç”¨ |
| prod_brand | å“ç‰Œ | å“ç‰Œåº“ |
| prod_spu | æ ‡å‡†äº§å“å•å…ƒ | SPUä¸»è¡¨ |
| prod_sku | åº“å­˜å•å…ƒ | SKUã€JSONBå±æ€§ |
| prod_attribute_template | å±æ€§æ¨¡æ¿ | åŠ¨æ€å±æ€§é…ç½® |

**ç‰¹æ€§**ï¼š
- âœ… pg_trgm å…¨æ–‡æœç´¢
- âœ… JSONB çµæ´»å±æ€§
- âœ… å¤šå“ç‰Œå¤šåˆ†ç±»æ”¯æŒ

### 2. **åº“å­˜æœåŠ¡** (011_db_inventory.sql)

| è¡¨å | è¯´æ˜ | å…³é”®ç‰¹æ€§ |
|-----|------|---------|
| inv_inventory | å®æ—¶åº“å­˜ | ä¹è§‚é”ã€åº“å­˜å¹³è¡¡çº¦æŸ |
| inv_reservation | åº“å­˜é¢„å ï¼ˆåˆ†åŒºï¼‰ | 15åˆ†é’Ÿè‡ªåŠ¨é‡Šæ”¾ |
| inv_log | åº“å­˜æµæ°´ï¼ˆåˆ†åŒºï¼‰ | æœˆåº¦åˆ†åŒº |
| inv_snapshot | åº“å­˜å¿«ç…§ | æ¯æ—¥å¿«ç…§ |
| inv_alert | åº“å­˜å‘Šè­¦ | ä½åº“å­˜/ç¼ºè´§å‘Šè­¦ |

**å‡½æ•°**ï¼š
- `fn_deduct_stock()` - åŸå­æ‰£å‡åº“å­˜
- `fn_release_reservation()` - é‡Šæ”¾é¢„å 

### 3. **è®¢å•æœåŠ¡** (012_db_order.sql)

| è¡¨å | è¯´æ˜ | å…³é”®ç‰¹æ€§ |
|-----|------|---------|
| ord_orderï¼ˆåˆ†åŒºï¼‰ | è®¢å•ä¸»è¡¨ | æœˆåº¦åˆ†åŒºã€JSONBåœ°å€ |
| ord_order_item | è®¢å•æ˜ç»† | ä»·æ ¼å¿«ç…§ |
| ord_status_history | çŠ¶æ€å†å² | è‡ªåŠ¨è®°å½•çŠ¶æ€å˜æ›´ |
| ord_payment | æ”¯ä»˜è®°å½• | ç¬¬ä¸‰æ–¹æ”¯ä»˜é›†æˆ |
| ord_refund | é€€æ¬¾/é€€è´§ | JSONBè¯æ®å›¾ç‰‡ |

**ç‰¹æ€§**ï¼š
- âœ… Spring State Machine çŠ¶æ€æµè½¬
- âœ… è‡ªåŠ¨è§¦å‘å™¨è®°å½•çŠ¶æ€å˜æ›´
- âœ… è®¢å•å·ç”Ÿæˆå‡½æ•°

### 4. **ä»“å‚¨æœåŠ¡** (013_db_warehouse.sql)

| è¡¨å | è¯´æ˜ | å…³é”®ç‰¹æ€§ |
|-----|------|---------|
| wms_warehouse | ä»“åº“ | 4ç§ä»“åº“ç±»å‹ |
| wms_location | åº“ä½ | å±‚çº§ç»“æ„ï¼ˆåŒº-æ¶-å±‚-ä½ï¼‰ |
| wms_inbound | å…¥åº“å• | å¤šæ¥æºï¼ˆé‡‡è´­/é€€è´§/è°ƒæ‹¨ï¼‰ |
| wms_inbound_item | å…¥åº“æ˜ç»† | è´¨é‡çŠ¶æ€ |
| wms_outbound | å‡ºåº“å• | JSONBæ‹£è´§è·¯å¾„ä¼˜åŒ– |
| wms_outbound_item | å‡ºåº“æ˜ç»† | - |
| wms_wave_picking | æ³¢æ¬¡æ‹£è´§ | è·¯å¾„ä¼˜åŒ–ç‡ |

**ç‰¹æ€§**ï¼š
- âœ… æ‹£è´§è·¯å¾„ä¼˜åŒ–ï¼ˆTSPé—®é¢˜ï¼‰
- âœ… æ³¢æ¬¡åˆå¹¶æ‹£è´§

### 5. **ç‰©æµæœåŠ¡** (014_db_logistics.sql)

| è¡¨å | è¯´æ˜ | å…³é”®ç‰¹æ€§ |
|-----|------|---------|
| tms_carrier | ç‰©æµå•† | APIé…ç½® |
| tms_waybill | è¿å• | JSONBåœ°å€ã€ç­¾æ”¶ä¿¡æ¯ |
| tms_tracking | ç‰©æµè½¨è¿¹ | GPSåæ ‡ |
| tms_route | é…é€è·¯çº¿ | è·¯å¾„ä¼˜åŒ–ç®—æ³•ï¼ˆTSP/GA/ACOï¼‰ |
| tms_delivery_area | é…é€åŒºåŸŸ | æ—¶æ•ˆè§„åˆ™ |

**ç‰¹æ€§**ï¼š
- âœ… PostGISåœ°ç†åæ ‡
- âœ… è½¨è¿¹è‡ªåŠ¨æ¨é€/æ‰‹åŠ¨å½•å…¥

### 6. **ä¾›åº”å•†æœåŠ¡** (015_db_supplier.sql)

| è¡¨å | è¯´æ˜ | å…³é”®ç‰¹æ€§ |
|-----|------|---------|
| sup_supplier | ä¾›åº”å•† | ä¿¡ç”¨è¯„çº§ï¼ˆA+~Dï¼‰ |
| sup_purchase_orderï¼ˆåˆ†åŒºï¼‰ | é‡‡è´­å• | æœˆåº¦åˆ†åŒº |
| sup_purchase_order_item | é‡‡è´­æ˜ç»† | - |
| sup_supplier_evaluation | ä¾›åº”å•†è¯„ä»· | å­£åº¦/æœˆåº¦è¯„ä»· |
| sup_settlement | å¯¹è´¦å• | UUIDæ•°ç»„å­˜é‡‡è´­å•IDs |

**ç‰¹æ€§**ï¼š
- âœ… ä¾›åº”å•†è¯„çº§ç³»ç»Ÿ
- âœ… ç»©æ•ˆç»Ÿè®¡è§†å›¾

---

## ğŸš€ Phase 1.5 - å¤šç§Ÿæˆ·ä¸é«˜çº§åŠŸèƒ½

### 7. **å¤šç§Ÿæˆ·æ”¯æ’‘** (016_db_tenant.sql) â­

| è¡¨å | è¯´æ˜ | å…³é”®ç‰¹æ€§ |
|-----|------|---------|
| tenant | ç§Ÿæˆ·ä¸»è¡¨ | è¯•ç”¨/æ­£å¼/æš‚åœçŠ¶æ€ |
| tenant_package | ç§Ÿæˆ·å¥—é¤ | åŸºç¡€/ä¸“ä¸š/ä¼ä¸š/æ——èˆ°ç‰ˆ |
| tenant_subscription | ç§Ÿæˆ·è®¢é˜… | æœˆä»˜/å¹´ä»˜ã€è‡ªåŠ¨ç»­è´¹ |
| tenant_resource_quota | èµ„æºé…é¢ | ç”¨æˆ·æ•°/SKUæ•°/è®¢å•é‡/å­˜å‚¨/API |
| tenant_config | ç§Ÿæˆ·é…ç½® | JSONBçµæ´»é…ç½® |
| tenant_feature | åŠŸèƒ½å¼€å…³ | BetaåŠŸèƒ½ã€ä½¿ç”¨æ¬¡æ•°é™åˆ¶ |
| tenant_operation_logï¼ˆåˆ†åŒºï¼‰ | æ“ä½œæ—¥å¿— | æœˆåº¦åˆ†åŒº |

**æ ¸å¿ƒå‡½æ•°**ï¼š
- `fn_check_tenant_quota()` - é…é¢æ£€æŸ¥

**è§†å›¾**ï¼š
- `v_tenant_quota_usage` - é…é¢ä½¿ç”¨æƒ…å†µ
- `v_expiring_tenants` - å³å°†è¿‡æœŸç§Ÿæˆ·ï¼ˆ30å¤©å†…ï¼‰

### 8. **è´¢åŠ¡ç»“ç®—** (017_db_finance.sql)

| è¡¨å | è¯´æ˜ | å…³é”®ç‰¹æ€§ |
|-----|------|---------|
| freight_rule | è¿è´¹è§„åˆ™ | é¦–é‡/ç»­é‡ã€æ»¡é¢å…è¿è´¹ |
| freight_calc_recordï¼ˆåˆ†åŒºï¼‰ | è¿è´¹è®¡ç®—è®°å½• | JSONBè®¡ç®—è¯¦æƒ… |
| settlement_order | ç»“ç®—å• | é‡‡è´­/é”€å”®/ç‰©æµç»“ç®— |
| settlement_item | ç»“ç®—æ˜ç»† | å…³è”è®¢å•/é‡‡è´­å•/è¿å• |
| invoice | å‘ç¥¨ | å¢å€¼ç¨ä¸“ç¥¨/æ™®ç¥¨/ç”µå­ç¥¨ |
| payment_recordï¼ˆåˆ†åŒºï¼‰ | ä»˜æ¬¾è®°å½• | é“¶è¡Œ/æ”¯ç¥¨/ç°é‡‘/æ‰¿å…‘/ç”µæ±‡ |
| reconciliation_record | å¯¹è´¦è®°å½• | å·®å¼‚æ£€æµ‹ |
| platform_service_fee | å¹³å°æœåŠ¡è´¹ | äº¤æ˜“ä½£é‡‘/å­˜å‚¨/APIè´¹ç”¨ |

**æ ¸å¿ƒå‡½æ•°**ï¼š
- `fn_calculate_freight()` - è¿è´¹è®¡ç®—å¼•æ“

**è§†å›¾**ï¼š
- `v_accounts_receivable` - åº”æ”¶è´¦æ¬¾æ±‡æ€»
- `v_accounts_payable` - åº”ä»˜è´¦æ¬¾æ±‡æ€»

---

## ğŸ”§ Phase 1.5 - æ‰©å±•åŠŸèƒ½

### æ‰©å±•1ï¼šåº“å­˜æ‰¹æ¬¡ç®¡ç† (002_add_inventory_batch_management.sql)

| è¡¨å | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| inv_batch | æ‰¹æ¬¡ç®¡ç† | é£Ÿå“/è¯å“ï¼ˆä¿è´¨æœŸç®¡ç†ï¼‰ |
| inv_lot | æ‰¹å·ç®¡ç† | åŒ»è¯/é£Ÿå“ï¼ˆè´¨é‡è¿½æº¯ï¼‰ |
| inv_serial | åºåˆ—å·ç®¡ç† | ç”µå­äº§å“/å¥¢ä¾ˆå“ï¼ˆä¸€ç‰©ä¸€ç ï¼‰ |
| inv_batch_flowï¼ˆåˆ†åŒºï¼‰ | æ‰¹æ¬¡æµæ°´ | æœˆåº¦åˆ†åŒº |
| inv_serial_trace | åºåˆ—å·æµè½¬ | å…¨æµç¨‹è¿½æº¯ |

**æ ¸å¿ƒç®—æ³•**ï¼š
- `fn_pick_batch_fefo()` - FEFOï¼ˆå…ˆè¿‡æœŸå…ˆå‡ºï¼‰é€‰æ‰¹ç®—æ³•
- `fn_update_near_expiry_alert()` - è‡ªåŠ¨ä¸´æœŸå‘Šè­¦ï¼ˆè§¦å‘å™¨ï¼‰

**è§†å›¾**ï¼š
- `v_near_expiry_inventory` - ä¸´æœŸå•†å“æ±‡æ€»ï¼ˆ30å¤©å†…ï¼‰
- `v_batch_inventory_summary` - æ‰¹æ¬¡åº“å­˜æ±‡æ€»

### æ‰©å±•2ï¼šé‡‡è´­å®¡æ‰¹æµç¨‹ (003_add_purchase_approval_workflow.sql)

| è¡¨å | è¯´æ˜ | å…³é”®ç‰¹æ€§ |
|-----|------|---------|
| purchase_request | é‡‡è´­ç”³è¯·å• | å¸¸è§„/ç´§æ€¥/é›¶æ˜Ÿé‡‡è´­ |
| purchase_request_item | ç”³è¯·æ˜ç»† | æ¨èä¾›åº”å•†ã€è´¨é‡è¦æ±‚ |
| purchase_request_approval | å®¡æ‰¹è®°å½• | åŒæ„/æ‹’ç»/è½¬å®¡/é€€å› |
| purchase_approval_config | å®¡æ‰¹æµç¨‹é…ç½® | JSONBå¤šçº§å®¡æ‰¹èŠ‚ç‚¹ |
| purchase_approval_task | å®¡æ‰¹å¾…åŠ | è¶…æ—¶æé†’ |

**æ ¸å¿ƒå‡½æ•°**ï¼š
- `fn_submit_purchase_request()` - æäº¤ç”³è¯·ï¼ˆå¯åŠ¨å®¡æ‰¹ï¼‰
- `fn_approve_purchase_request()` - å®¡æ‰¹å¤„ç†

**è§†å›¾**ï¼š
- `v_my_approval_tasks` - æˆ‘çš„å¾…å®¡æ‰¹ä»»åŠ¡

### æ‰©å±•3ï¼šå¤šç§Ÿæˆ·æ”¹é€  (001_add_tenant_id_to_business_tables.sql)

**æ”¹é€ å†…å®¹**ï¼š
- âœ… æ‰€æœ‰ä¸šåŠ¡è¡¨æ·»åŠ  `tenant_id UUID NOT NULL`
- âœ… æ·»åŠ å¤–é”®çº¦æŸ `FOREIGN KEY (tenant_id) REFERENCES tenant(id)`
- âœ… é‡å»ºç´¢å¼•ï¼Œå°† tenant_id ä½œä¸ºé¦–åˆ—
- âœ… ä¿®æ”¹å”¯ä¸€çº¦æŸï¼ŒåŒ…å« tenant_id

**æ¶‰åŠè¡¨æ•°é‡**ï¼š34å¼ ä¸šåŠ¡è¡¨

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

### Phase 1 + Phase 1.5 æ€»è®¡

| åˆ†ç±» | æ•°æ®åº“æ•° | è¡¨æ•°é‡ | åˆ†åŒºè¡¨ | è§†å›¾ | å‡½æ•° |
|-----|---------|--------|-------|------|------|
| **æ ¸å¿ƒä¸šåŠ¡** | 6 | 34 | 6 | 4 | 4 |
| **å¤šç§Ÿæˆ·æ”¯æ’‘** | 1 | 7 | 1 | 2 | 1 |
| **è´¢åŠ¡ç»“ç®—** | 1 | 8 | 2 | 2 | 1 |
| **æ‰¹æ¬¡ç®¡ç†æ‰©å±•** | - | 5 | 1 | 2 | 2 |
| **å®¡æ‰¹æµç¨‹æ‰©å±•** | - | 5 | 0 | 1 | 2 |
| **åˆè®¡** | **8** | **59** | **10** | **11** | **10** |

---

## ğŸ—ï¸ æŠ€æœ¯ç‰¹æ€§

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” | ç¤ºä¾‹ |
|-----|------|------|
| **UUID v7** | æ—¶é—´æœ‰åºä¸»é”® | åç«¯ UUIDv7Util ç”Ÿæˆ |
| **PostgreSQL 16+** | å…³ç³»å‹æ•°æ®åº“ | JSONB, åˆ†åŒºè¡¨, è§¦å‘å™¨ |
| **JSONB** | çµæ´»æ•°æ®å­˜å‚¨ | åœ°å€ã€å±æ€§ã€é…ç½®ã€è½¨è¿¹ |
| **Range Partitioning** | æ•°æ®åˆ†åŒº | æŒ‰æœˆåˆ†åŒºï¼ˆè®¢å•ã€æ—¥å¿—ã€æµæ°´ï¼‰ |
| **GIN Index** | JSONBç´¢å¼• | é«˜æ•ˆæŸ¥è¯¢JSONå­—æ®µ |
| **PostGIS** | åœ°ç†åæ ‡ | ç‰©æµè½¨è¿¹ã€é…é€è·¯çº¿ |
| **pg_trgm** | å…¨æ–‡æœç´¢ | å•†å“åç§°æ¨¡ç³Šæœç´¢ |
| **Triggers** | è‡ªåŠ¨åŒ– | çŠ¶æ€å˜æ›´è®°å½•ã€ä¸´æœŸå‘Šè­¦ |
| **Foreign Keys** | æ•°æ®å®Œæ•´æ€§ | ç§Ÿæˆ·éš”ç¦»ã€å…³è”çº¦æŸ |
| **CHECK Constraints** | ä¸šåŠ¡è§„åˆ™ | é‡‘é¢éè´Ÿã€åº“å­˜å¹³è¡¡ |

### æ€§èƒ½ä¼˜åŒ–

1. **åˆ†åŒºè¡¨ç­–ç•¥**ï¼š
   - è®¢å•ã€æ”¯ä»˜ã€æ—¥å¿—ã€æµæ°´æŒ‰æœˆåˆ†åŒº
   - è‡ªåŠ¨æ‰©å±•ï¼šéœ€å®šæœŸæ·»åŠ æ–°åˆ†åŒº

2. **ç´¢å¼•ç­–ç•¥**ï¼š
   - æ‰€æœ‰æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
   - å¤šç§Ÿæˆ·æŸ¥è¯¢ï¼š`(tenant_id, ...)`
   - éƒ¨åˆ†ç´¢å¼•ï¼š`WHERE NOT deleted`

3. **JSONBä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ `->` å’Œ `->>` æ“ä½œç¬¦
   - GINç´¢å¼•åŠ é€ŸJSONæŸ¥è¯¢
   - é¿å…è¿‡åº¦ä½¿ç”¨JSONB

4. **ä¹è§‚é”**ï¼š
   - åº“å­˜è¡¨ä½¿ç”¨ `version` å­—æ®µ
   - é¿å…å¹¶å‘æ›´æ–°å†²çª

---

## ğŸ”’ æ•°æ®éš”ç¦»ç­–ç•¥

### å¤šç§Ÿæˆ·éš”ç¦»æ–¹æ¡ˆ

**é€‰æ‹©æ–¹æ¡ˆï¼šå…±äº«è¡¨ + tenant_id**

| ä¼˜åŠ¿ | åŠ£åŠ¿ |
|-----|------|
| âœ… è¿ç»´æˆæœ¬ä½ | âš ï¸ éœ€åº”ç”¨å±‚ä¸¥æ ¼è¿‡æ»¤ |
| âœ… èµ„æºåˆ©ç”¨ç‡é«˜ | âš ï¸ æ•°æ®éš”ç¦»ä¾èµ–ä»£ç  |
| âœ… å¤‡ä»½æ¢å¤ç®€å• | - |
| âœ… é€‚åˆä¸­å¤§è§„æ¨¡ | - |

### å®‰å…¨å¢å¼ºï¼ˆå¯é€‰ï¼‰

```sql
-- PostgreSQL Row Level Security (RLS)
ALTER TABLE ord_order ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation ON ord_order
    USING (tenant_id = current_setting('app.tenant_id')::UUID);
```

---

## ğŸ“¦ éƒ¨ç½²æŒ‡å—

### 1. åˆå§‹åŒ–é¡ºåº

```bash
# Step 1: åˆ›å»ºåŸºç¡€æ•°æ®åº“
psql -U postgres -c "CREATE DATABASE db_tenant WITH ENCODING = 'UTF8';"

# Step 2: åˆå§‹åŒ–ç§Ÿæˆ·ç®¡ç†
psql -U postgres -d db_tenant -f 016_db_tenant.sql

# Step 3: åˆ›å»ºæ ¸å¿ƒä¸šåŠ¡æ•°æ®åº“
for i in {010..015}; do
    DB_NAME=$(grep "CREATE DATABASE" ${i}_*.sql | head -1 | awk '{print $3}')
    psql -U postgres -c "CREATE DATABASE ${DB_NAME} WITH ENCODING = 'UTF8';"
    psql -U postgres -d ${DB_NAME} -f ${i}_*.sql
done

# Step 4: åˆ›å»ºè´¢åŠ¡æ•°æ®åº“
psql -U postgres -c "CREATE DATABASE db_finance WITH ENCODING = 'UTF8';"
psql -U postgres -d db_finance -f 017_db_finance.sql

# Step 5: æ‰§è¡Œè¿ç§»è„šæœ¬
psql -U postgres -d db_product -f migrations/001_add_tenant_id_to_business_tables.sql
psql -U postgres -d db_inventory -f migrations/002_add_inventory_batch_management.sql
psql -U postgres -d db_supplier -f migrations/003_add_purchase_approval_workflow.sql
```

### 2. åˆå§‹æ•°æ®

```sql
-- åˆ›å»ºé»˜è®¤ç§Ÿæˆ·
INSERT INTO tenant (id, tenant_code, tenant_name, status, admin_username)
VALUES (
    gen_random_uuid(),
    'DEFAULT',
    'é»˜è®¤ç§Ÿæˆ·',
    1,
    'admin'
);

-- åˆ›å»ºé»˜è®¤å¥—é¤
INSERT INTO tenant_package (package_code, package_name, package_level, ...)
VALUES ('BASIC', 'åŸºç¡€ç‰ˆ', 1, ...);
```

---

## ğŸ”„ å®šæœŸç»´æŠ¤ä»»åŠ¡

### æ¯æ—¥ä»»åŠ¡

1. **é…é¢é‡ç½®**ï¼š
   ```sql
   UPDATE tenant_resource_quota
   SET current_orders_today = 0,
       current_api_calls_today = 0
   WHERE last_order_reset_date < CURRENT_DATE;
   ```

2. **ä¸´æœŸå•†å“æ‰«æ**ï¼š
   ```sql
   -- è§¦å‘å™¨è‡ªåŠ¨å¤„ç†ï¼Œæˆ–å®šæ—¶ä»»åŠ¡å¼ºåˆ¶æ‰«æ
   SELECT * FROM v_near_expiry_inventory;
   ```

### æ¯æœˆä»»åŠ¡

1. **æ·»åŠ æ–°åˆ†åŒº**ï¼š
   ```sql
   -- è®¢å•è¡¨
   CREATE TABLE ord_order_2025_04 PARTITION OF ord_order
       FOR VALUES FROM ('2025-04-01') TO ('2025-05-01');

   -- å…¶ä»–åˆ†åŒºè¡¨åŒç†
   ```

2. **ç”Ÿæˆå¹³å°æœåŠ¡è´¹**ï¼š
   ```sql
   -- è®¡ç®—ä¸Šæœˆäº¤æ˜“é‡ï¼Œç”ŸæˆæœåŠ¡è´¹è´¦å•
   INSERT INTO platform_service_fee (...);
   ```

### å­£åº¦ä»»åŠ¡

1. **ä¾›åº”å•†è¯„ä»·**ï¼š
   ```sql
   -- ç”Ÿæˆå­£åº¦ä¾›åº”å•†è¯„ä»·
   INSERT INTO sup_supplier_evaluation (...);
   ```

2. **æ•°æ®å½’æ¡£**ï¼š
   ```bash
   # å½’æ¡£1å¹´å‰çš„åˆ†åŒº
   pg_dump --table=ord_order_2024_01 > archive/ord_order_2024_01.sql
   DROP TABLE ord_order_2024_01;
   ```

---

## ğŸš§ åç»­è§„åˆ’

### Phase 2ï¼ˆæœªæ¥6-12ä¸ªæœˆï¼‰

1. **é«˜çº§åŠŸèƒ½**ï¼š
   - â³ é€†å‘ç‰©æµï¼ˆé€€è´§/æ¢è´§ï¼‰- 5-6å¼ è¡¨
   - â³ APSè®¡åˆ’ç³»ç»Ÿï¼ˆéœ€æ±‚é¢„æµ‹ã€è¡¥è´§è®¡åˆ’ï¼‰- 6-8å¼ è¡¨
   - â³ è´¨é‡ç®¡ç†ï¼ˆè´¨æ£€ã€ä¸åˆæ ¼å“å¤„ç†ï¼‰- 4-5å¼ è¡¨
   - â³ æŠ¥è¡¨ä¸­å¿ƒï¼ˆBIåˆ†æï¼‰- æ•°æ®ä»“åº“

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - â³ è¯»å†™åˆ†ç¦»ï¼ˆPostgreSQLä¸»ä»ï¼‰
   - â³ ç¼“å­˜ç­–ç•¥ï¼ˆRedisé›†æˆï¼‰
   - â³ åˆ†åº“åˆ†è¡¨ï¼ˆShardingï¼‰
   - â³ CQRSæ¨¡å¼ï¼ˆå‘½ä»¤æŸ¥è¯¢åˆ†ç¦»ï¼‰

3. **å®‰å…¨å¢å¼º**ï¼š
   - â³ å­—æ®µçº§åŠ å¯†ï¼ˆæ•æ„Ÿæ•°æ®ï¼‰
   - â³ å®¡è®¡æ—¥å¿—å¢å¼º
   - â³ RLSå¼ºåˆ¶å¯ç”¨
   - â³ æ•°æ®è„±æ•

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [PostgreSQL 16 å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/16/)
- [MyBatis-Plus 3.5.15](https://baomidou.com/)
- [Spring Boot 3.x](https://spring.io/projects/spring-boot)
- [Seata 2.2.0](https://seata.io/)
- [é¡¹ç›®æ¶æ„è®¾è®¡æ–‡æ¡£](../../docs/ARCHITECTURE_DESIGN.md)

---

## âš ï¸ é‡è¦æç¤º

1. **tenant_id å¿…é¡»**ï¼šæ‰€æœ‰æŸ¥è¯¢å¿…é¡»åŒ…å« tenant_id æ¡ä»¶
2. **åˆ†åŒºç»´æŠ¤**ï¼šæ¯æœˆåˆæ·»åŠ ä¸‹æœˆåˆ†åŒº
3. **å¤‡ä»½ç­–ç•¥**ï¼šæ¯æ—¥å¢é‡ + æ¯å‘¨å…¨é‡å¤‡ä»½
4. **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®æ•°æ®åº“ç›‘æ§ï¼ˆè¿æ¥æ•°ã€æ…¢æŸ¥è¯¢ã€ç£ç›˜ï¼‰
5. **æƒé™æ§åˆ¶**ï¼šä¸¥æ ¼çš„RBAC + æ•°æ®æƒé™è¿‡æ»¤
6. **SQLå®¡æ ¸**ï¼šä¸Šçº¿å‰å¿…é¡»ç»è¿‡DBAå®¡æ ¸

---

**Last Updated**: 2025-01-24
**Version**: Phase 1.5
**Author**: Claude Opus 4.5
