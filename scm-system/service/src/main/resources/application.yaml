server:
  port: 8081

spring:
  application:
    name: system-service
  config:
    import:
      - optional:nacos:${spring.application.name}.yaml?server-addr=${spring.cloud.nacos.server-addr}
      - optional:nacos:common.yaml?server-addr=${spring.cloud.nacos.server-addr}
  cloud:
    nacos:
      server-addr: ${NACOS_SERVER:127.0.0.1:8848}
      config:
        enabled: true
        namespace: ${NACOS_NAMESPACE:public}
        group: ${NACOS_GROUP:DEFAULT_GROUP}
  # ========== 多数据源配置 ==========
  datasource:
    dynamic:
      primary: user                    # 默认数据源
      strict: true                     # 严格匹配，未找到则报错

      # HikariCP 全局连接池配置
      hikari:
        minimum-idle: 5
        maximum-pool-size: 20
        idle-timeout: 30000
        max-lifetime: 1800000
        connection-timeout: 30000

      datasource:
        # 用户数据库 - sys_user, sys_user_oauth, webauthn_credential
        user:
          driver-class-name: org.postgresql.Driver
          url: jdbc:postgresql://${DB_HOST:192.168.18.134}:5432/db_user
          username: ${DB_USERNAME:admin}
          password: ${DB_PASSWORD:123456}

        # 组织数据库 - sys_dept
        org:
          driver-class-name: org.postgresql.Driver
          url: jdbc:postgresql://${DB_HOST:192.168.18.134}:5432/db_org
          username: ${DB_USERNAME:admin}
          password: ${DB_PASSWORD:123456}

        # 权限数据库 - sys_role, sys_permission, sys_user_role, etc.
        permission:
          driver-class-name: org.postgresql.Driver
          url: jdbc:postgresql://${DB_HOST:192.168.18.134}:5432/db_permission
          username: ${DB_USERNAME:admin}
          password: ${DB_PASSWORD:123456}

        # 审批数据库 - sys_permission_approval
        approval:
          driver-class-name: org.postgresql.Driver
          url: jdbc:postgresql://${DB_HOST:192.168.18.134}:5432/db_approval
          username: ${DB_USERNAME:admin}
          password: ${DB_PASSWORD:123456}

        # 审计数据库 - sys_audit_log, sys_sensitive_operation_log
        audit:
          driver-class-name: org.postgresql.Driver
          url: jdbc:postgresql://${DB_HOST:192.168.18.134}:5432/db_audit
          username: ${DB_USERNAME:admin}
          password: ${DB_PASSWORD:123456}

        # 通知数据库 - sys_notification_audit, sys_notification_template, etc.
        notify:
          driver-class-name: org.postgresql.Driver
          url: jdbc:postgresql://${DB_HOST:192.168.18.134}:5432/db_notify
          username: ${DB_USERNAME:admin}
          password: ${DB_PASSWORD:123456}

    # ========== 读写分离（主从） ==========
    # 开启后将通过 common/data 的 ReadWriteRoutingDataSource 在每个库内做 master/slave 路由，
    # 仍由 dynamic-datasource 负责在 user/org/permission/... 这些库之间选择（@DS）。
    rw:
      enabled: ${RW_ENABLED:true}

      # 全局负载均衡策略: ROUND_ROBIN, WEIGHTED_ROUND_ROBIN, RANDOM, WEIGHTED_RANDOM, LEAST_CONNECTIONS
      load-balance: WEIGHTED_ROUND_ROBIN

      # 写后读主库持续时间（解决读写一致性，写入后2秒内读操作走主库）
      read-master-after-write: 2s

      # 复制延迟容忍（超过此值强制走主库）
      replication-lag-tolerance: 1s

      # 健康检查配置
      health-check-enabled: true
      health-check-interval: 30s
      failure-threshold: 3

      groups:
        # 用户数据库
        user:
          master:
            url: jdbc:postgresql://${DB_MASTER_HOST:192.168.18.134}:5432/db_user
            username: ${DB_USERNAME:admin}
            password: ${DB_PASSWORD:123456}
            driver-class-name: org.postgresql.Driver
            minimum-idle: 5
            maximum-pool-size: 20
          slaves:
            - name: slave1
              url: jdbc:postgresql://${DB_SLAVE1_HOST:192.168.18.135}:5432/db_user
              username: ${DB_USERNAME:admin}
              password: ${DB_PASSWORD:123456}
              driver-class-name: org.postgresql.Driver
              weight: 2
              minimum-idle: 3
              maximum-pool-size: 15
            - name: slave2
              url: jdbc:postgresql://${DB_SLAVE2_HOST:192.168.18.136}:5432/db_user
              username: ${DB_USERNAME:admin}
              password: ${DB_PASSWORD:123456}
              driver-class-name: org.postgresql.Driver
              weight: 1
              minimum-idle: 3
              maximum-pool-size: 15

        # 组织数据库
        org:
          master:
            url: jdbc:postgresql://${DB_MASTER_HOST:192.168.18.134}:5432/db_org
            username: ${DB_USERNAME:admin}
            password: ${DB_PASSWORD:123456}
            driver-class-name: org.postgresql.Driver
            minimum-idle: 5
            maximum-pool-size: 20
          slaves:
            - name: slave1
              url: jdbc:postgresql://${DB_SLAVE1_HOST:192.168.18.135}:5432/db_org
              username: ${DB_USERNAME:admin}
              password: ${DB_PASSWORD:123456}
              driver-class-name: org.postgresql.Driver
              weight: 2
            - name: slave2
              url: jdbc:postgresql://${DB_SLAVE2_HOST:192.168.18.136}:5432/db_org
              username: ${DB_USERNAME:admin}
              password: ${DB_PASSWORD:123456}
              driver-class-name: org.postgresql.Driver
              weight: 1

        # 权限数据库
        permission:
          master:
            url: jdbc:postgresql://${DB_MASTER_HOST:192.168.18.134}:5432/db_permission
            username: ${DB_USERNAME:admin}
            password: ${DB_PASSWORD:123456}
            driver-class-name: org.postgresql.Driver
            minimum-idle: 5
            maximum-pool-size: 20
          slaves:
            - name: slave1
              url: jdbc:postgresql://${DB_SLAVE1_HOST:192.168.18.135}:5432/db_permission
              username: ${DB_USERNAME:admin}
              password: ${DB_PASSWORD:123456}
              driver-class-name: org.postgresql.Driver
              weight: 2
            - name: slave2
              url: jdbc:postgresql://${DB_SLAVE2_HOST:192.168.18.136}:5432/db_permission
              username: ${DB_USERNAME:admin}
              password: ${DB_PASSWORD:123456}
              driver-class-name: org.postgresql.Driver
              weight: 1

        # 审批数据库
        approval:
          master:
            url: jdbc:postgresql://${DB_MASTER_HOST:192.168.18.134}:5432/db_approval
            username: ${DB_USERNAME:admin}
            password: ${DB_PASSWORD:123456}
            driver-class-name: org.postgresql.Driver
            minimum-idle: 3
            maximum-pool-size: 10
          slaves:
            - name: slave1
              url: jdbc:postgresql://${DB_SLAVE1_HOST:192.168.18.135}:5432/db_approval
              username: ${DB_USERNAME:admin}
              password: ${DB_PASSWORD:123456}
              driver-class-name: org.postgresql.Driver
              weight: 1

        # 审计数据库
        audit:
          master:
            url: jdbc:postgresql://${DB_MASTER_HOST:192.168.18.134}:5432/db_audit
            username: ${DB_USERNAME:admin}
            password: ${DB_PASSWORD:123456}
            driver-class-name: org.postgresql.Driver
            minimum-idle: 3
            maximum-pool-size: 10
          slaves:
            - name: slave1
              url: jdbc:postgresql://${DB_SLAVE1_HOST:192.168.18.135}:5432/db_audit
              username: ${DB_USERNAME:admin}
              password: ${DB_PASSWORD:123456}
              driver-class-name: org.postgresql.Driver
              weight: 1

        # 通知数据库
        notify:
          master:
            url: jdbc:postgresql://${DB_MASTER_HOST:192.168.18.134}:5432/db_notify
            username: ${DB_USERNAME:admin}
            password: ${DB_PASSWORD:123456}
            driver-class-name: org.postgresql.Driver
            minimum-idle: 3
            maximum-pool-size: 10
          slaves:
            - name: slave1
              url: jdbc:postgresql://${DB_SLAVE1_HOST:192.168.18.135}:5432/db_notify
              username: ${DB_USERNAME:admin}
              password: ${DB_PASSWORD:123456}
              driver-class-name: org.postgresql.Driver
              weight: 1
  security:
    default-password: 123456


mybatis-plus:
  # Mapper XML 文件位置
  mapper-locations: classpath*:/mapper/**/*.xml
  # 实体类包路径
  type-aliases-package: com.frog.system.entity
  # 全局配置
  global-config:
    db-config:
      # 表名前缀
      table-prefix: tbl_
      # 逻辑删除字段
      logic-delete-field: deleted
      # 逻辑删除值
      logic-delete-value: 1
      # 逻辑未删除值
      logic-not-delete-value: 0
  configuration:
    # 开启驼峰命名转换
    map-underscore-to-camel-case: true
    # SQL日志输出
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
    # 缓存
    cache-enabled: false

dubbo:
  application:
    name: ${spring.application.name}
  protocol:
    name: dubbo
    port: -1
  registry:
    address: nacos://${spring.cloud.nacos.server-addr}
